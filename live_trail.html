<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Calor Run</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏱️</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root {
  --primary-blue: #215E99;
  --primary-pink: #E61780;
  --header-bg: #e0e0e0;
  --bg-light: #f9f9f9;
  --bg-white: #fff;
}

/* Fond de page dégradé estompé comme participants.html */
body {
  font-family: system-ui, -apple-system, sans-serif;
  margin: 20px;
  background: var(--bg-light);
  line-height: 1.4;
  overflow-x: hidden;
  transition: background 0.3s, color 0.3s;
  min-height: 100vh;
  position: relative;
}
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: linear-gradient(0.25turn, var(--primary-blue), var(--primary-pink));
  opacity: 0.3;
  z-index: -1;
}

/* Chronomètre avec calor.png à 80% visible, sans style de cadre */
.chrono-container { 
  text-align: center; 
  margin: 20px 0 30px; 
  padding: 0; 
  color: white; 
  position: relative;
  background-image: url('calor.png');
  background-repeat: no-repeat;
  background-position: center center;
  background-size: 80% auto;
  overflow: visible;
  min-height: 180px;
  border: none;
  border-radius: 0;
  box-shadow: none;
  background-color: transparent;
}
/* Suppression de l'overlay blanc */
.chrono-container::before { display: none !important; }

.chrono-time {
  position: relative;
  z-index: 1;
  font-family: 'Orbitron', 'Courier New', monospace;
  /*font-family: 'Share Tech Mono', monospace;*/
  font-variant-numeric: tabular-nums;
  font-size: 3rem;
  font-weight: bold;
  letter-spacing: 0.1em;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 8em;
  background: none;
  border-radius: 0;
  padding: 0;
}
.chrono-time span { margin-left: 0; }
@media (max-width: 480px) { .chrono-time { font-size: 2rem; } }
.chrono-time.paused { opacity: 0.7; }

/* Loading & compteurs */
.loading { text-align: center; font-size: 1.2rem; color: #666; margin: 40px 0; }
.compteurs { text-align: center; margin-bottom: 30px; font-size: clamp(0.9rem, 2.5vw, 1.1rem); font-weight: bold; }
.compteur { display: inline-block; margin: 5px 10px; padding: 10px 15px; color: white; border-radius: 5px; min-width: 120px; transition: transform 0.2s ease; }
.compteur.updated { animation: bounce 0.6s ease; }
@keyframes bounce { 0%,20%,50%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-10px); } 60% { transform: translateY(-5px); } }
.compteur:nth-child(1) { background: #215E99; }
.compteur:nth-child(2) { background: #E61780; }

/* Tableau */
.table-container { overflow-x: auto; margin-bottom: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
table { width: 100%; border-collapse: collapse; background: var(--bg-white); min-width: 800px; }
th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 0.9rem; }
th {
  background: var(--header-bg);
  color: #333;
  font-weight: bold;
  position: sticky;
  top: 0;
  z-index: 10;
}
tbody tr:nth-child(odd) { background: #fff; }
tbody tr:nth-child(even) { background: var(--bg-light); }

/* Erreurs & dernières mises à jour */
.error { text-align: center; color: #d32f2f; font-weight: bold; margin: 40px 0; padding: 20px; background: #ffebee; border-radius: 8px; }
.last-update { text-align: center; color: #666; font-size: 0.9rem; margin-top: 20px; }

/* Dark theme */
body.dark { background: #121212; color: #eee; }
body.dark .chrono-container { background-image: url('calor.png'); background-color: transparent; }
body.dark table { background: #1e1e1e; color: #eee; }
body.dark th { background: #444; color: #fff; }
body.dark tbody tr:nth-child(odd) { background: #1e1e1e; }
body.dark tbody tr:nth-child(even) { background: #2a2a2a; }
</style>
</head>
<body>

<div id="chrono-container" class="chrono-container">
  <div class="chrono-time" id="chrono-time">
    <span id="chrono-text">--:--:--</span>
  </div>
</div>

<div id="loading" class="loading">Connexion en temps réel...</div>

<div id="compteurs" class="compteurs" style="display:none;">
  <div class="compteur" id="compteur-10">10km : <span id="count-10">0</span> arrivés</div>
  <div class="compteur" id="compteur-20">20km : <span id="count-20">0</span> arrivés</div>
</div>

<div class="table-container" id="table-container" style="display:none;">
  <table id="classement">
    <thead>
      <tr>
        <th>Dossard</th><th>Nom</th><th>Prénom</th><th>Temps</th><th>Course</th>
        <th>Scratch</th><th>Genre</th><th>Pos. Genre</th><th>CAT</th><th>Pos. CAT</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="error" class="error" style="display:none;"></div>

<p class="last-update" id="last-update" style="display:none;">
  Dernière mise à jour : <span id="update-time">--:--:--</span>
  · <a href="#" id="theme-toggle">Basculer le thème</a>
</p>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const elements = {
  chronoTime: document.getElementById('chrono-time'),
  chronoText: document.getElementById('chrono-text'),
  loading: document.getElementById('loading'),
  compteurs: document.getElementById('compteurs'),
  count10: document.getElementById('count-10'),
  count20: document.getElementById('count-20'),
  compteur10: document.getElementById('compteur-10'),
  compteur20: document.getElementById('compteur-20'),
  tbody: document.querySelector('#classement tbody'),
  tableContainer: document.getElementById('table-container'),
  error: document.getElementById('error'),
  lastUpdate: document.getElementById('last-update'),
  updateTime: document.getElementById('update-time'),
  themeToggle: document.getElementById('theme-toggle')
};

let departureTimestamp = null, participants = {}, scans = {}, currentClassement = [], previousCounts = { count10: 0, count20: 0 }, chronoInterval = null;

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain: "calor-run.firebaseapp.com",
  databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calor-run",
  storageBucket: "calor-run.firebasestorage.app",
  messagingSenderId: "329949291334",
  appId: "1:329949291334:web:c71ef20268c609cf953b47",
  measurementId: "G-YVQPW6JGPK"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function formatTime(ms) {
  const sec = Math.floor(ms / 1000),
        h = Math.floor(sec / 3600).toString().padStart(2,'0'),
        m = Math.floor((sec % 3600)/60).toString().padStart(2,'0'),
        s = (sec % 60).toString().padStart(2,'0');
  return `${h}:${m}:${s}`;
}

// Chrono
function startChrono() {
  if (chronoInterval) clearInterval(chronoInterval);
  if (!departureTimestamp) {
    elements.chronoText.textContent = "--:--:--";
    elements.chronoTime.classList.add('paused');
    return;
  }
  elements.chronoTime.classList.remove('paused');
  const update = () => {
    const elapsed = Date.now() - departureTimestamp;
    const text = elapsed < 0 ? `-${formatTime(Math.abs(elapsed))}` : formatTime(elapsed);
    elements.chronoText.textContent = text;
    elements.chronoTime.classList.toggle('paused', elapsed < 0);
  };
  update();
  chronoInterval = setInterval(update, 1000);
}
function stopChrono() {
  if (chronoInterval) { clearInterval(chronoInterval); chronoInterval=null; }
  elements.chronoText.textContent="--:--:--";
  elements.chronoTime.classList.add('paused');
}

// Classement
function createTableRow(p) {
  const tr = document.createElement('tr');
  // If tempsMs is negative, show "--:--:--" instead of a negative time
  const tempsDisplay = (typeof p.tempsMs === "number" && p.tempsMs < 0) ? "--:--:--" : p.tempsStr;
  tr.innerHTML = `<td>${p.dossard}</td><td>${p.nom}</td><td>${p.prenom}</td><td>${tempsDisplay}</td><td>${p.course}</td><td>${p.scratch}</td><td>${p.genre}</td><td>${p.posGenre}</td><td>${p.categorie}</td><td>${p.posCat}</td>`;
  return tr;
}

function calculatePositions(classement) {
  const scratchCounter={}, genreCounter={}, catCounter={};
  let count10=0, count20=0;
  classement.forEach(p=>{
    const c = String(p.course).trim();
    if (c==='10'||c==='10km'||c==='10 km') count10++;
    else if (c==='20'||c==='20km'||c==='20 km') count20++;
    scratchCounter[p.course]=(scratchCounter[p.course]||0)+1; p.scratch=scratchCounter[p.course];
    const keyG = `${p.course}_${p.genre}`; genreCounter[keyG]=(genreCounter[keyG]||0)+1; p.posGenre=genreCounter[keyG];
    const keyC = `${p.course}_${p.categorie}`; catCounter[keyC]=(catCounter[keyC]||0)+1; p.posCat=catCounter[keyC];
  });
  return { count10, count20 };
}

function displayData(classement, count10, count20) {
  const fragment = document.createDocumentFragment();
  classement.forEach(p=>fragment.appendChild(createTableRow(p)));
  elements.tbody.innerHTML=''; elements.tbody.appendChild(fragment);
  elements.loading.style.display='none'; elements.error.style.display='none'; elements.compteurs.style.display='block'; elements.tableContainer.style.display='block';
  elements.count10.textContent=count10; elements.count20.textContent=count20;
  const now = new Date(); elements.updateTime.textContent = now.toLocaleTimeString('fr-FR'); elements.lastUpdate.style.display='block';
  currentClassement=[...classement];
}

// Classement update
function updateClassement() {
  if (!departureTimestamp || Object.keys(scans).length===0) return;
  try {
    let classement = Object.keys(scans).map(dossard=>{
      const scan=scans[dossard], part=participants[dossard]||{}, tempsMs=new Date(scan.dateTime).getTime()-departureTimestamp;
      return { dossard, nom:part.nom||'', prenom:part.prenom||'', tempsMs, tempsStr:formatTime(tempsMs), course:part.course||'', genre:part.genre||'', categorie:part.categorie||'' };
    }).sort((a,b)=>b.tempsMs-a.tempsMs); // plus long en haut
    const {count10,count20}=calculatePositions(classement);
    displayData(classement,count10,count20);
  } catch(e){console.error(e);}
}

// Dark theme toggle
elements.themeToggle.addEventListener('click', e=>{ e.preventDefault(); document.body.classList.toggle('dark'); });

// Firebase listeners
db.ref('data/depart_course').on('value', snap=>{ departureTimestamp = snap.exists()?new Date(snap.val()).getTime():null; departureTimestamp?startChrono():stopChrono(); updateClassement(); });
db.ref('participants').on('value', snap=>{ participants = snap.val()||{}; updateClassement(); });
db.ref('scan_dossards').on('value', snap=>{ scans = snap.val()||{}; updateClassement(); });
window.addEventListener('beforeunload', ()=>{ if (chronoInterval) clearInterval(chronoInterval); });
</script>

</body>
</html>
