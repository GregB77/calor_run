<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Calor Run</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏱️</text></svg>">
<style>
:root {
  --header-bg: #b0b0b0;
  --header-text: #222;
  --bg-white: #fff;
  --bg-light: #f9f9f9;
  --chrono-font: 'Consolas', 'Courier New', monospace;
}

body {
  font-family: system-ui, -apple-system, sans-serif;
  margin: 0;
  background: var(--bg-light);
  line-height: 1.4;
  min-height: 100vh;
  /* Fond dégradé estompé */
  position: relative;
}
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; width: 100vw; height: 100vh;
  background: linear-gradient(0.25turn, #215E99, #E61780);
  opacity: 0.3;
  z-index: -1;
}

/* Barre du chrono pleine largeur */
.chrono-bg {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 100vw;
  min-width: 100vw;
  margin: 0 0 32px 0;
  /* Plus de border radius, plus d'ombre, ni bordure */
  border-radius: 0;
  overflow: hidden;
  position: relative;
  background: url('calor.png') center center/cover no-repeat;
  aspect-ratio: 5/1;
  min-height: 120px;
  box-shadow: none;
  border: none;
}
.chrono-time {
  position: absolute;
  left: 50%; top: 50%; transform: translate(-50%, -50%);
  color: #fff;
  font-family: var(--chrono-font);
  font-size: clamp(2.5rem, 7vw, 4.5rem);
  font-weight: bold;
  letter-spacing: 0.12em;
  text-shadow: 0 0 16px #222, 0 2px 8px #000a;
  background: rgba(0,0,0,0.12);
  padding: 0.2em 0.8em;
  border-radius: 0.6em;
  user-select: none;
}
.chrono-time.paused { opacity: 0.7; }

.table-container {
  width: 100vw;
  margin: 0 0 40px 0;
  overflow-x: auto;
  background: var(--bg-white);
  border-radius: 0;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
table {
  width: 100%;
  border-collapse: collapse;
  min-width: 800px;
  background: transparent;
}
th, td {
  padding: 10px 8px;
  text-align: center;
  font-size: 0.97rem;
}
th {
  background: var(--header-bg);
  color: var(--header-text);
  font-weight: bold;
  border: 1px solid #fff; /* Bordure blanche entre colonnes et lignes */
  position: sticky;
  top: 0;
  z-index: 10;
}
td {
  border: 1px solid #ddd;
  background: transparent;
}
tbody tr:nth-child(odd) { background: #fff; }
tbody tr:nth-child(even) { background: var(--bg-light); }
tbody tr { transition: background 0.2s; }
tbody tr:hover { background: #eaf4ff; }

.loading { text-align: center; font-size: 1.2rem; color: #666; margin: 40px 0; }
.compteurs { text-align: center; margin-bottom: 30px; font-size: clamp(0.9rem, 2.5vw, 1.1rem); font-weight: bold; }
.compteur { display: inline-block; margin: 5px 10px; padding: 10px 15px; color: white; border-radius: 5px; min-width: 120px;}
.compteur:nth-child(1) { background: #215E99; }
.compteur:nth-child(2) { background: #E61780; }

.error { text-align: center; color: #d32f2f; font-weight: bold; margin: 40px 0; padding: 20px; background: #ffebee; border-radius: 8px; }
.last-update { text-align: center; color: #666; font-size: 0.9rem; margin-top: 20px; }

@media (max-width: 900px) {
  table { min-width: 600px; }
}
@media (max-width: 700px) {
  .table-container, .chrono-bg { width: 100vw; min-width: 100vw; }
  table { min-width: 400px; }
}
/* Dark theme */
body.dark { background: #121212; color: #eee; }
body.dark .table-container { background: #222; }
body.dark th { background: #444; color: #fff; border: 1px solid #222; }
body.dark td { background: transparent; border: 1px solid #333; }
body.dark tbody tr:nth-child(odd) { background: #222; }
body.dark tbody tr:nth-child(even) { background: #292929; }
body.dark tbody tr:hover { background: #2a3c4c; }
</style>
</head>
<body>

<div class="chrono-bg">
  <div class="chrono-time" id="chrono-time">
    <span id="chrono-text">--:--:--</span>
  </div>
</div>

<div id="loading" class="loading">Connexion en temps réel...</div>

<div id="compteurs" class="compteurs" style="display:none;">
  <div class="compteur" id="compteur-10">10km : <span id="count-10">0</span> arrivés</div>
  <div class="compteur" id="compteur-20">20km : <span id="count-20">0</span> arrivés</div>
</div>

<div class="table-container" id="table-container" style="display:none;">
  <table id="classement">
    <thead>
      <tr>
        <th>Dossard</th><th>Nom</th><th>Prénom</th><th>Temps</th><th>Course</th>
        <th>Scratch</th><th>Genre</th><th>Pos. Genre</th><th>CAT</th><th>Pos. CAT</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="error" class="error" style="display:none;"></div>

<p class="last-update" id="last-update" style="display:none;">
  Dernière mise à jour : <span id="update-time">--:--:--</span>
  · <a href="#" id="theme-toggle">Basculer le thème</a>
</p>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const elements = {
  chronoTime: document.getElementById('chrono-time'),
  chronoText: document.getElementById('chrono-text'),
  loading: document.getElementById('loading'),
  compteurs: document.getElementById('compteurs'),
  count10: document.getElementById('count-10'),
  count20: document.getElementById('count-20'),
  compteur10: document.getElementById('compteur-10'),
  compteur20: document.getElementById('compteur-20'),
  tbody: document.querySelector('#classement tbody'),
  tableContainer: document.getElementById('table-container'),
  error: document.getElementById('error'),
  lastUpdate: document.getElementById('last-update'),
  updateTime: document.getElementById('update-time'),
  themeToggle: document.getElementById('theme-toggle')
};

let departureTimestamp = null, participants = {}, scans = {}, currentClassement = [], previousCounts = { count10: 0, count20: 0 }, chronoInterval = null;

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain: "calor-run.firebaseapp.com",
  databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "calor-run",
  storageBucket: "calor-run.firebasestorage.app",
  messagingSenderId: "329949291334",
  appId: "1:329949291334:web:c71ef20268c609cf953b47",
  measurementId: "G-YVQPW6JGPK"
};

const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function formatTime(ms) {
  const sec = Math.floor(ms / 1000),
        h = Math.floor(sec / 3600).toString().padStart(2,'0'),
        m = Math.floor((sec % 3600)/60).toString().padStart(2,'0'),
        s = (sec % 60).toString().padStart(2,'0');
  return `${h}:${m}:${s}`;
}

// Chrono
function startChrono() {
  if (chronoInterval) clearInterval(chronoInterval);
  if (!departureTimestamp) {
    elements.chronoText.textContent = "--:--:--";
    elements.chronoTime.classList.add('paused');
    return;
  }
  elements.chronoTime.classList.remove('paused');
  const update = () => {
    const elapsed = Date.now() - departureTimestamp;
    const text = elapsed < 0 ? `-${formatTime(Math.abs(elapsed))}` : formatTime(elapsed);
    elements.chronoText.textContent = text;
    elements.chronoTime.classList.toggle('paused', elapsed < 0);
  };
  update();
  chronoInterval = setInterval(update, 1000);
}
function stopChrono() {
  if (chronoInterval) { clearInterval(chronoInterval); chronoInterval=null; }
  elements.chronoText.textContent="--:--:--";
  elements.chronoTime.classList.add('paused');
}

// Classement
function createTableRow(p) {
  const tr = document.createElement('tr');
  // If tempsMs is negative, show "--:--:--" instead of a negative time
  const tempsDisplay = (typeof p.tempsMs === "number" && p.tempsMs < 0) ? "--:--:--" : p.tempsStr;
  tr.innerHTML = `<td>${p.dossard}</td><td>${p.nom}</td><td>${p.prenom}</td><td>${tempsDisplay}</td><td>${p.course}</td><td>${p.scratch}</td><td>${p.genre}</td><td>${p.posGenre}</td><td>${p.categorie}</td><td>${p.posCat}</td>`;
  return tr;
}

function calculatePositions(classement) {
  const scratchCounter={}, genreCounter={}, catCounter={};
  let count10=0, count20=0;
  classement.forEach(p=>{
    const c = String(p.course).trim();
    if (c==='10'||c==='10km'||c==='10 km') count10++;
    else if (c==='20'||c==='20km'||c==='20 km') count20++;
    scratchCounter[p.course]=(scratchCounter[p.course]||0)+1; p.scratch=scratchCounter[p.course];
    const keyG = `${p.course}_${p.genre}`; genreCounter[keyG]=(genreCounter[keyG]||0)+1; p.posGenre=genreCounter[keyG];
    const keyC = `${p.course}_${p.categorie}`; catCounter[keyC]=(catCounter[keyC]||0)+1; p.posCat=catCounter[keyC];
  });
  return { count10, count20 };
}

function displayData(classement, count10, count20) {
  const fragment = document.createDocumentFragment();
  classement.forEach(p=>fragment.appendChild(createTableRow(p)));
  elements.tbody.innerHTML=''; elements.tbody.appendChild(fragment);
  elements.loading.style.display='none'; elements.error.style.display='none'; elements.compteurs.style.display='block'; elements.tableContainer.style.display='block';
  elements.count10.textContent=count10; elements.count20.textContent=count20;
  const now = new Date(); elements.updateTime.textContent = now.toLocaleTimeString('fr-FR'); elements.lastUpdate.style.display='block';
  currentClassement=[...classement];
}

// Classement update
function updateClassement() {
  if (!departureTimestamp || Object.keys(scans).length===0) return;
  try {
    let classement = Object.keys(scans).map(dossard=>{
      const scan=scans[dossard], part=participants[dossard]||{}, tempsMs=new Date(scan.dateTime).getTime()-departureTimestamp;
      return { dossard, nom:part.nom||'', prenom:part.prenom||'', tempsMs, tempsStr:formatTime(tempsMs), course:part.course||'', genre:part.genre||'', categorie:part.categorie||'' };
    }).sort((a,b)=>b.tempsMs-a.tempsMs); // plus long en haut
    const {count10,count20}=calculatePositions(classement);
    displayData(classement,count10,count20);
  } catch(e){console.error(e);}
}

// Dark theme toggle
elements.themeToggle.addEventListener('click', e=>{ e.preventDefault(); document.body.classList.toggle('dark'); });

// Firebase listeners
db.ref('data/depart_course').on('value', snap=>{ departureTimestamp = snap.exists()?new Date(snap.val()).getTime():null; departureTimestamp?startChrono():stopChrono(); updateClassement(); });
db.ref('participants').on('value', snap=>{ participants = snap.val()||{}; updateClassement(); });
db.ref('scan_dossards').on('value', snap=>{ scans = snap.val()||{}; updateClassement(); });
window.addEventListener('beforeunload', ()=>{ if (chronoInterval) clearInterval(chronoInterval); });
</script>

</body>
</html>
