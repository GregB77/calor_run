<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Calor Run</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏱️</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-blue: #215E99;
      --primary-pink: #E61780;
      --bg-overlay: rgba(33, 94, 153, 0.3);
      --text-dark: #333;
      --bg-white: #fff;
      --bg-light: #f9f9f9;
      --header-bg: #e0e0e0;
      --border-radius: 8px;
      --shadow-light: rgba(0, 0, 0, 0.1);
      --shadow-medium: rgba(0, 0, 0, 0.15);
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.5;
      color: var(--text-dark);
      min-height: 100vh;
      padding: 20px;
      position: relative;
      overflow-x: hidden;
      background: var(--bg-light);
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(0.25turn, var(--primary-blue), var(--primary-pink));
      opacity: 0.3;
      z-index: -1;
    }

    /* Bandeau avec chrono et image */
    .header {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary-blue);
      font-size: 1.3rem;
      font-weight: normal;
      padding: 20px 20px 60px 20px;
      border-radius: 10px;
      background: url('calor.png') center/80% no-repeat;
      position: relative;
    }

    .chrono-time {
      position: relative;
      z-index: 1;
      font-family: 'Share Tech Mono', monospace;
      font-variant-numeric: tabular-nums;
      font-size: 2.5rem;
      font-weight: bold;
      letter-spacing: 0.1em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 8em;
      color: var(--primary-blue);
      text-align: center;
      margin: 0 auto;
    }
    .chrono-time.paused { opacity: 0.7; }
    @media (max-width: 480px) { .chrono-time { font-size: 2rem; } }

    /* Compteurs */
    .counter-box {
      display: flex;
      justify-content: center;
      gap: 16px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .compteur {
      padding: 10px 16px;
      border-radius: var(--border-radius);
      color: white;
      min-width: 120px;
      text-align: center;
      font-weight: bold;
    }
    .compteur-10 { background: var(--primary-blue); }
    .compteur-20 { background: var(--primary-pink); }

    /* Tableau */
    .table-container {
      background: var(--bg-white);
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 4px 12px var(--shadow-medium);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 0.9rem;
    }

    th {
      background: var(--header-bg);
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    tbody tr:nth-child(odd) { background: #fff; }
    tbody tr:nth-child(even) { background: var(--bg-light); }

    .loading {
      text-align: center;
      padding: 40px;
      font-size: 1.1rem;
      color: var(--primary-blue);
    }

    .error {
      text-align: center;
      color: #d32f2f;
      font-weight: bold;
      margin: 40px 0;
      padding: 20px;
      background: #ffebee;
      border-radius: 8px;
    }

    .last-update {
      text-align: center;
      color: #666;
      font-size: 0.9rem;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="chrono-time" id="chrono-time">
      <span id="chrono-text">--:--:--</span>
    </div>
  </div>

  <div id="loading" class="loading">Connexion en temps réel...</div>

  <div class="counter-box" id="compteurs" style="display:none;">
    <div class="compteur compteur-10">10 km : <span id="count-10">0</span></div>
    <div class="compteur compteur-20">20 km : <span id="count-20">0</span></div>
  </div>

  <div class="table-container" id="table-container" style="display:none;">
    <table id="classement">
      <thead>
        <tr>
          <th>Dossard</th><th>Nom</th><th>Prénom</th><th>Temps</th><th>Course</th>
          <th>Scratch</th><th>Genre</th><th>Pos. Genre</th><th>CAT</th><th>Pos. CAT</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="error" class="error" style="display:none;"></div>

  <p class="last-update" id="last-update" style="display:none;">
    Dernière mise à jour : <span id="update-time">--:--:--</span>
  </p>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Elements
    const elements = {
      chronoTime: document.getElementById('chrono-time'),
      chronoText: document.getElementById('chrono-text'),
      loading: document.getElementById('loading'),
      compteurs: document.getElementById('compteurs'),
      count10: document.getElementById('count-10'),
      count20: document.getElementById('count-20'),
      tbody: document.querySelector('#classement tbody'),
      tableContainer: document.getElementById('table-container'),
      error: document.getElementById('error'),
      lastUpdate: document.getElementById('last-update'),
      updateTime: document.getElementById('update-time')
    };

    let departureTimestamp = null,
        participants = {},
        scans = {},
        chronoInterval = null;

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
      authDomain: "calor-run.firebaseapp.com",
      databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calor-run",
      storageBucket: "calor-run.firebasestorage.app",
      messagingSenderId: "329949291334",
      appId: "1:329949291334:web:c71ef20268c609cf953b47",
      measurementId: "G-YVQPW6JGPK"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Utils
    function formatTime(ms) {
      const sec = Math.floor(ms / 1000);
      const h = String(Math.floor(sec / 3600)).padStart(2, '0');
      const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    // Chrono
    function startChrono() {
      clearInterval(chronoInterval);
      if (!departureTimestamp) {
        elements.chronoText.textContent = "--:--:--";
        elements.chronoTime.classList.add('paused');
        return;
      }
      elements.chronoTime.classList.remove('paused');
      const update = () => {
        const elapsed = Date.now() - departureTimestamp;
        elements.chronoText.textContent = elapsed < 0 ? `-${formatTime(Math.abs(elapsed))}` : formatTime(elapsed);
        elements.chronoTime.classList.toggle('paused', elapsed < 0);
      };
      update();
      chronoInterval = setInterval(update, 1000);
    }
    function stopChrono() {
      clearInterval(chronoInterval);
      elements.chronoText.textContent = "--:--:--";
      elements.chronoTime.classList.add('paused');
    }

    // Tableau
    function createTableRow(p) {
      const tr = document.createElement('tr');
      const tempsDisplay = (typeof p.tempsMs === "number" && p.tempsMs < 0) ? "--:--:--" : p.tempsStr;
      tr.innerHTML = `<td>${p.dossard}</td><td>${p.nom}</td><td>${p.prenom}</td><td>${tempsDisplay}</td><td>${p.course}</td><td>${p.scratch}</td><td>${p.genre}</td><td>${p.posGenre}</td><td>${p.categorie}</td><td>${p.posCat}</td>`;
      return tr;
    }

    function calculatePositions(classement) {
      const scratchCounter = {}, genreCounter = {}, catCounter = {};
      let count10 = 0, count20 = 0;

      // On parcourt du premier arrivé (fin) vers le dernier (début)
      for (let i = classement.length - 1; i >= 0; i--) {
        const p = classement[i];
        const c = String(p.course).trim();

        if (["10", "10km", "10 km"].includes(c)) count10++;
        else if (["20", "20km", "20 km"].includes(c)) count20++;

        scratchCounter[p.course] = (scratchCounter[p.course] || 0) + 1;
        p.scratch = scratchCounter[p.course];

        genreCounter[`${p.course}_${p.genre}`] = (genreCounter[`${p.course}_${p.genre}`] || 0) + 1;
        p.posGenre = genreCounter[`${p.course}_${p.genre}`];

        catCounter[`${p.course}_${p.categorie}`] = (catCounter[`${p.course}_${p.categorie}`] || 0) + 1;
        p.posCat = catCounter[`${p.course}_${p.categorie}`];
      }

      return { count10, count20 };
    }

    function displayData(classement, count10, count20) {
      const fragment = document.createDocumentFragment();
      classement.forEach(p => fragment.appendChild(createTableRow(p)));
      elements.tbody.innerHTML = '';
      elements.tbody.appendChild(fragment);
      elements.loading.style.display = 'none';
      elements.error.style.display = 'none';
      elements.compteurs.style.display = 'flex';
      elements.tableContainer.style.display = 'block';
      elements.count10.textContent = count10;
      elements.count20.textContent = count20;
      elements.updateTime.textContent = new Date().toLocaleTimeString('fr-FR');
      elements.lastUpdate.style.display = 'block';
    }

    function updateClassement() {
      if (!departureTimestamp || Object.keys(scans).length === 0) return;
      try {
        let classement = Object.keys(scans).map(dossard => {
          const scan = scans[dossard], part = participants[dossard] || {};
          const tempsMs = new Date(scan.dateTime).getTime() - departureTimestamp;
          return {
            dossard,
            nom: part.nom || '',
            prenom: part.prenom || '',
            tempsMs,
            tempsStr: formatTime(tempsMs),
            course: part.course || '',
            genre: part.genre || '',
            categorie: part.categorie || ''
          };
        }).sort((a, b) => b.tempsMs - a.tempsMs); // plus long en haut (dernier arrivé en haut)
        const { count10, count20 } = calculatePositions(classement);
        displayData(classement, count10, count20);
      } catch (e) {
        console.error(e);
      }
    }

    // Firebase listeners
    db.ref('data/depart_course').on('value', snap => {
      departureTimestamp = snap.exists() ? new Date(snap.val()).getTime() : null;
      departureTimestamp ? startChrono() : stopChrono();
      updateClassement();
    });
    db.ref('participants').on('value', snap => {
      participants = snap.val() || {};
      updateClassement();
    });
    db.ref('scan_dossards').on('value', snap => {
      scans = snap.val() || {};
      updateClassement();
    });

    window.addEventListener('beforeunload', () => { clearInterval(chronoInterval); });
  </script>
</body>
</html>
