<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Live Calor Run</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏱️</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-blue: #215E99;
      --primary-pink: #E61780;
      --header-bg: #e0e0e0;
      --bg-light: #f9f9f9;
      --bg-white: #fff;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 20px;
      background: var(--bg-light);
      line-height: 1.4;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      transition: background 0.3s, color 0.3s;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: linear-gradient(0.25turn, var(--primary-blue), var(--primary-pink));
      opacity: 0.3;
      z-index: -1;
    }

    .chrono-container {
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      min-height: 180px;
      background: transparent url('calor.png') no-repeat center/80% auto;
      color: white;
      overflow: visible;
    }

    .chrono-container::before { display: none !important; }
    .chrono-time {
      position: relative;
      z-index: 1;
      font-family: 'Share Tech Mono', monospace;
      font-variant-numeric: tabular-nums;
      font-size: 2.5rem;
      font-weight: bold;
      letter-spacing: 0.1em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 8em;
      color: var(--primary-blue);
      text-align: center;
      margin: 0 auto;
      border: none;
    }
    .chrono-time.paused { opacity: 0.7; }
    @media (max-width: 480px) { .chrono-time { font-size: 2rem; } }

    .loading { text-align: center; font-size: 1.2rem; color: #666; margin: 40px 0; }
    .compteurs { text-align: center; margin-bottom: 30px; font-size: clamp(0.9rem, 2.5vw, 1.1rem); font-weight: bold; }
    .compteur { display: inline-block; margin: 5px 10px; padding: 10px 15px; color: white; border-radius: 5px; min-width: 120px; transition: transform 0.2s; }
    .compteur:nth-child(1) { background: #215E99; }
    .compteur:nth-child(2) { background: #E61780; }

    .table-container { overflow-x: auto; margin-bottom: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; background: var(--bg-white); min-width: 800px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; font-size: 0.9rem; }
    th {
      background: var(--header-bg);
      color: #333;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    tbody tr:nth-child(odd) { background: #fff; }
    tbody tr:nth-child(even) { background: var(--bg-light); }

    .error { text-align: center; color: #d32f2f; font-weight: bold; margin: 40px 0; padding: 20px; background: #ffebee; border-radius: 8px; }
    .last-update { text-align: center; color: #666; font-size: 0.9rem; margin-top: 20px; }
  </style>
</head>
<body>

  <div class="chrono-container">
    <div class="chrono-time" id="chrono-time">
      <span id="chrono-text">--:--:--</span>
    </div>
  </div>

  <div id="loading" class="loading">Connexion en temps réel...</div>

  <div id="compteurs" class="compteurs" style="display:none;">
    <div class="compteur" id="compteur-10">10km : <span id="count-10">0</span> arrivés</div>
    <div class="compteur" id="compteur-20">20km : <span id="count-20">0</span> arrivés</div>
  </div>

  <div class="table-container" id="table-container" style="display:none;">
    <table id="classement">
      <thead>
        <tr>
          <th>Dossard</th><th>Nom</th><th>Prénom</th><th>Temps</th><th>Course</th>
          <th>Scratch</th><th>Genre</th><th>Pos. Genre</th><th>CAT</th><th>Pos. CAT</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="error" class="error" style="display:none;"></div>

  <p class="last-update" id="last-update" style="display:none;">
    Dernière mise à jour : <span id="update-time">--:--:--</span>
  </p>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Elements
    const elements = {
      chronoTime: document.getElementById('chrono-time'),
      chronoText: document.getElementById('chrono-text'),
      loading: document.getElementById('loading'),
      compteurs: document.getElementById('compteurs'),
      count10: document.getElementById('count-10'),
      count20: document.getElementById('count-20'),
      tbody: document.querySelector('#classement tbody'),
      tableContainer: document.getElementById('table-container'),
      error: document.getElementById('error'),
      lastUpdate: document.getElementById('last-update'),
      updateTime: document.getElementById('update-time')
    };

    // Global state
    let departureTimestamp = null,
        participants = {},
        scans = {},
        chronoInterval = null;

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
      authDomain: "calor-run.firebaseapp.com",
      databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calor-run",
      storageBucket: "calor-run.firebasestorage.app",
      messagingSenderId: "329949291334",
      appId: "1:329949291334:web:c71ef20268c609cf953b47",
      measurementId: "G-YVQPW6JGPK"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Utils
    function formatTime(ms) {
      const sec = Math.floor(ms / 1000);
      const h = String(Math.floor(sec / 3600)).padStart(2, '0');
      const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${h}:${m}:${s}`;
    }

    // Chrono
    function startChrono() {
      clearInterval(chronoInterval);
      if (!departureTimestamp) {
        elements.chronoText.textContent = "--:--:--";
        elements.chronoTime.classList.add('paused');
        return;
      }
      elements.chronoTime.classList.remove('paused');
      const update = () => {
        const elapsed = Date.now() - departureTimestamp;
        elements.chronoText.textContent = elapsed < 0 ? `-${formatTime(Math.abs(elapsed))}` : formatTime(elapsed);
        elements.chronoTime.classList.toggle('paused', elapsed < 0);
      };
      update();
      chronoInterval = setInterval(update, 1000);
    }
    function stopChrono() {
      clearInterval(chronoInterval);
      elements.chronoText.textContent = "--:--:--";
      elements.chronoTime.classList.add('paused');
    }

    // Tableau
    function createTableRow(p) {
      const tr = document.createElement('tr');
      const tempsDisplay = (typeof p.tempsMs === "number" && p.tempsMs < 0) ? "--:--:--" : p.tempsStr;
      tr.innerHTML = `<td>${p.dossard}</td><td>${p.nom}</td><td>${p.prenom}</td><td>${tempsDisplay}</td><td>${p.course}</td><td>${p.scratch}</td><td>${p.genre}</td><td>${p.posGenre}</td><td>${p.categorie}</td><td>${p.posCat}</td>`;
      return tr;
    }

    function calculatePositions(classement) {
      const scratchCounter = {}, genreCounter = {}, catCounter = {};
      let count10 = 0, count20 = 0;
      classement.forEach(p => {
        const c = String(p.course).trim();
        if (["10", "10km", "10 km"].includes(c)) count10++;
        else if (["20", "20km", "20 km"].includes(c)) count20++;
        scratchCounter[p.course] = (scratchCounter[p.course] || 0) + 1; p.scratch = scratchCounter[p.course];
        genreCounter[`${p.course}_${p.genre}`] = (genreCounter[`${p.course}_${p.genre}`] || 0) + 1; p.posGenre = genreCounter[`${p.course}_${p.genre}`];
        catCounter[`${p.course}_${p.categorie}`] = (catCounter[`${p.course}_${p.categorie}`] || 0) + 1; p.posCat = catCounter[`${p.course}_${p.categorie}`];
      });
      return { count10, count20 };
    }

    function displayData(classement, count10, count20) {
      const fragment = document.createDocumentFragment();
      classement.forEach(p => fragment.appendChild(createTableRow(p)));
      elements.tbody.innerHTML = '';
      elements.tbody.appendChild(fragment);
      elements.loading.style.display = 'none';
      elements.error.style.display = 'none';
      elements.compteurs.style.display = 'block';
      elements.tableContainer.style.display = 'block';
      elements.count10.textContent = count10;
      elements.count20.textContent = count20;
      elements.updateTime.textContent = new Date().toLocaleTimeString('fr-FR');
      elements.lastUpdate.style.display = 'block';
    }

    function updateClassement() {
      if (!departureTimestamp || Object.keys(scans).length === 0) return;
      try {
        let classement = Object.keys(scans).map(dossard => {
          const scan = scans[dossard], part = participants[dossard] || {};
          const tempsMs = new Date(scan.dateTime).getTime() - departureTimestamp;
          return {
            dossard,
            nom: part.nom || '',
            prenom: part.prenom || '',
            tempsMs,
            tempsStr: formatTime(tempsMs),
            course: part.course || '',
            genre: part.genre || '',
            categorie: part.categorie || ''
          };
        }).sort((a, b) => b.tempsMs - a.tempsMs); // plus long en haut
        const { count10, count20 } = calculatePositions(classement);
        displayData(classement, count10, count20);
      } catch (e) {
        console.error(e);
      }
    }

    // Firebase listeners
    db.ref('data/depart_course').on('value', snap => {
      departureTimestamp = snap.exists() ? new Date(snap.val()).getTime() : null;
      departureTimestamp ? startChrono() : stopChrono();
      updateClassement();
    });
    db.ref('participants').on('value', snap => {
      participants = snap.val() || {};
      updateClassement();
    });
    db.ref('scan_dossards').on('value', snap => {
      scans = snap.val() || {};
      updateClassement();
    });

    window.addEventListener('beforeunload', () => { clearInterval(chronoInterval); });
  </script>
</body>
</html>
