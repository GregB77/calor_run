<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stats Calor Run</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono:wght@400&display=swap" rel="stylesheet">
<style>
:root {
  --primary-color: #215E99;
  --secondary-color: #E61780;
  --bg-white: #fff;
  --bg-light: #f9f9f9;
  --shadow: rgba(0,0,0,0.15);
  --border-radius: 0.5rem;
  --max-width: 62.5rem;
  --text-dark: #333;
  --border-light: #ddd;
  --header-bg: #e0e0e0;
}
* { box-sizing: border-box; margin:0; padding:0; }
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.5;
  color: var(--text-dark);
  min-height: 100vh;
  padding: 1.25rem;
  position: relative;
}
body::before {
  content:''; position: fixed; inset:0;
  background: linear-gradient(0.25turn, var(--primary-color), var(--secondary-color));
  opacity:0.3;
  z-index:-1;
  pointer-events: none;
}
.container { max-width: var(--max-width); margin:0 auto; }
.header {
  text-align:center;
  margin-bottom:0.625rem;
  color: var(--primary-color);
  font-size:1.3rem;
  font-weight:bold;
  padding:1.25rem 1.25rem 3.75rem;
  background:url('calor.png') center/contain no-repeat;
}
.table-container {
  max-width: var(--max-width);
  overflow-x:auto;
  margin:0 auto 1.25rem;
  background: var(--bg-white);
  border-radius: var(--border-radius);
  box-shadow: 0 0.25rem 0.75rem var(--shadow);
  padding: 0.5rem;
}
.table-title {
  font-weight: bold;
  font-size: 1rem;
  margin-bottom: 0.5rem;
  color: var(--primary-color);
}
table { width:100%; border-collapse: collapse; min-width:43.75rem; }
th, td { padding:0.375rem 0.5rem; border-bottom:1px solid var(--border-light); text-align:left; white-space: nowrap; }
th { background: var(--header-bg); font-weight:600; position:sticky; top:0; z-index:10; }

tbody tr:nth-child(even){ background: var(--bg-light); }
.muted { color:#777; }

#tbl-cat th, #tbl-cat td { text-align: center; }
#tbl-age th:nth-child(1),#tbl-age td:nth-child(1), #tbl-age th:nth-child(4), #tbl-age td:nth-child(4), #tbl-age th:nth-child(5), #tbl-age td:nth-child(5), #tbl-age th:nth-child(8), #tbl-age td:nth-child(8) { text-align: center; }
#tbl-clubs th:nth-child(1), #tbl-clubs td:nth-child(1), #tbl-clubs th:nth-child(3), #tbl-clubs td:nth-child(3) { text-align: center; }
  
/* Ligne verticale s√©paratrice pour le tableau des √¢ges */
#tbl-age th.separator,
#tbl-age td.separator {
  border-left: 2px solid var(--primary-color);
  padding-left: 0.75rem;
}

@media (max-width:768px){
  .header { margin-bottom:0.625rem; padding:0rem 0rem 1.5rem; font-size:1rem; }
  table { min-width:auto; font-size:0.85rem; }
  th, td { padding:0.375rem 0.5rem; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">STATISTIQUES CALOR RUN</div>

  <!-- Tableau 1 : R√©partition par cat√©gories -->
  <div class="table-container">
    <div class="table-title">R√©partition par cat√©gories</div>
    <table id="tbl-cat">
      <thead>
        <tr>
          <th>Cat√©gorie</th>
          <th>Femmes (10km)</th>
          <th>Hommes (10km)</th>
          <th>Total (10km)</th>
          <th>Femmes (20km)</th>
          <th>Hommes (20km)</th>
          <th>Total (20km)</th>
          <th>Total g√©n√©ral</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="8" class="muted">Chargement‚Ä¶</td></tr></tbody>
    </table>
  </div>

  <!-- Tableau 2 : √Çges fusionn√© -->
  <div class="table-container">
    <div class="table-title">Plus et moins √¢g√©s 10 et 20 km</div>
    <table id="tbl-age">
      <thead>
        <tr>
          <th>Dossard</th><th>Pr√©nom</th><th>Nom</th><th>√Çge</th>
          <th class="separator">Dossard</th><th>Pr√©nom</th><th>Nom</th><th>√Çge</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="8" class="muted">Chargement‚Ä¶</td></tr></tbody>
    </table>
  </div>

  <!-- Tableau 3 : Classement des clubs -->
  <div class="table-container">
    <div class="table-title">Clubs les plus repr√©sent√©s</div>
    <table id="tbl-clubs">
      <thead>
        <tr>
          <th>Rang</th>
          <th>Club</th>
          <th>Participants</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="3" class="muted">Chargement‚Ä¶</td></tr></tbody>
    </table>
  </div>
</div>

<div id="err" class="error" style="display:none;color:red;text-align:center;margin-top:1rem;"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain:"calor-run.firebaseapp.com",
  databaseURL:"https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"calor-run",
  storageBucket:"calor-run.firebasestorage.app",
  messagingSenderId:"329949291334",
  appId:"1:329949291334:web:c71ef20268c609cf953b47"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const el = {
  cat: document.querySelector('#tbl-cat tbody'),
  age: document.querySelector('#tbl-age tbody'),
  clubs: document.querySelector('#tbl-clubs tbody'),
  err: document.getElementById('err')
};

const orderCat = ['CA','JU','ES','SE','M0','M1','M2','M3','M4','M5','M6','M7','M8','M9','M10'];

function parseDate(d){if(!d)return null;const dt=new Date(d);return isNaN(dt.getTime())?null:dt;}
function computeAge(d){if(!d)return null;const today=new Date();let a=today.getFullYear()-d.getFullYear();if(today.getMonth()<d.getMonth()||(today.getMonth()===d.getMonth()&&today.getDate()<d.getDate()))a--;return a;}

function renderCats(body, data){
  const counts = {10:{},20:{}};
  Object.values(data||{}).forEach(p=>{
    const course = Number(p.course)||0;
    const cat = p.categorie||'‚Äî';
    const genre = (p.genre||'').toLowerCase();
    counts[course][cat] = counts[course][cat]||{f:0,h:0};
    if(genre==='f' || genre==='femme') counts[course][cat].f++;
    else counts[course][cat].h++;
  });

  const rows=[];
  let tot10f=0,tot10h=0,tot20f=0,tot20h=0;
  orderCat.forEach(cat=>{
    const v10 = counts[10][cat]||{f:0,h:0};
    const v20 = counts[20][cat]||{f:0,h:0};
    const t10 = v10.f+v10.h;
    const t20 = v20.f+v20.h;
    const total = t10+t20;
    rows.push(`<tr>
      <td>${cat}</td>
      <td>${v10.f}</td><td>${v10.h}</td><td>${t10}</td>
      <td>${v20.f}</td><td>${v20.h}</td><td>${t20}</td>
      <td>${total}</td>
    </tr>`);
    tot10f+=v10.f; tot10h+=v10.h;
    tot20f+=v20.f; tot20h+=v20.h;
  });

  const tot10 = tot10f+tot10h;
  const tot20 = tot20f+tot20h;
  const grandTotal = tot10+tot20;

  rows.push(`<tr style="font-weight:700">
    <td>Totaux</td>
    <td>${tot10f} (${Math.round(100*tot10f/tot10||0)}%)</td>
    <td>${tot10h} (${Math.round(100*tot10h/tot10||0)}%)</td>
    <td>${tot10}</td>
    <td>${tot20f} (${Math.round(100*tot20f/tot20||0)}%)</td>
    <td>${tot20h} (${Math.round(100*tot20h/tot20||0)}%)</td>
    <td>${tot20}</td>
    <td>${grandTotal}</td>
  </tr>`);

  body.innerHTML = rows.join('');
}

function renderAges(body, data){
  const ages = {10: [], 20: []};
  
  Object.values(data||{}).forEach(p=>{
    const course = Number(p.course)||0;
    const birth = parseDate(p.date_naiss);
    const age = computeAge(birth);
    if(!birth || age===null) return;
    const pack = {dossard:p.dossard||'', prenom:p.prenom||'', nom:p.nom||'', age};
    if(course===10) ages[10].push(pack);
    if(course===20) ages[20].push(pack);
  });

  function getOldestYoungest(arr){
    if(!arr.length) return [{},{}];
    let oldest = arr[0], youngest = arr[0];
    for(const p of arr){
      if(p.age > oldest.age) oldest = p;
      if(p.age < youngest.age) youngest = p;
    }
    return [oldest, youngest];
  }

  const rows10 = getOldestYoungest(ages[10]);
  const rows20 = getOldestYoungest(ages[20]);

  body.innerHTML = `
    <tr>
      <td>${rows10[0]?.dossard||''}</td><td>${rows10[0]?.prenom||''}</td><td>${rows10[0]?.nom||''}</td><td>${rows10[0]?.age||''}</td>
      <td class="separator">${rows20[0]?.dossard||''}</td><td>${rows20[0]?.prenom||''}</td><td>${rows20[0]?.nom||''}</td><td>${rows20[0]?.age||''}</td>
    </tr>
    <tr>
      <td>${rows10[1]?.dossard||''}</td><td>${rows10[1]?.prenom||''}</td><td>${rows10[1]?.nom||''}</td><td>${rows10[1]?.age||''}</td>
      <td class="separator">${rows20[1]?.dossard||''}</td><td>${rows20[1]?.prenom||''}</td><td>${rows20[1]?.nom||''}</td><td>${rows20[1]?.age||''}</td>
    </tr>
  `;
}

function renderClubs(body, data){
  const clubsCount = {};
  Object.values(data||{}).forEach(p=>{
    const club = (p.club || '').trim();
    if(!club) return;
    clubsCount[club] = (clubsCount[club]||0) + 1;
  });

  const sortedClubs = Object.entries(clubsCount)
    .filter(([club,count])=>count>0)
    .sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));

  const rows = sortedClubs.map((c,i)=>`<tr><td>${i+1}</td><td>${c[0]}</td><td>${c[1]}</td></tr>`);
  body.innerHTML = rows.join('') || '<tr><td colspan="3" class="muted">Aucune donn√©e.</td></tr>';
}

function showError(msg){el.err.style.display='block'; el.err.textContent=msg;}

db.ref('participants').on('value',snap=>{
  try{
    const data = snap.val()||{};
    renderCats(el.cat,data);
    renderAges(el.age,data);
    renderClubs(el.clubs,data);
  }catch(e){
    console.error(e);
    showError("Erreur traitement : "+e.message);
  }
},err=>{console.error(err);showError("Erreur Firebase : "+err.message);});
</script>

</body>
</html>
