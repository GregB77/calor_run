<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>STATISTIQUES</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono:wght@400&display=swap" rel="stylesheet">
<style>
:root {
  --primary-color: #215E99;
  --secondary-color: #E61780;
  --bg-white: #fff;
  --bg-light: #f9f9f9;
  --shadow: rgba(0,0,0,0.15);
  --border-radius: 0.5rem;
  --max-width: 62.5rem;
  --text-dark: #333;
  --border-light: #ddd;
  --header-bg: #e0e0e0;
}
* { box-sizing: border-box; margin:0; padding:0; }
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.5;
  color: var(--text-dark);
  min-height: 100vh;
  padding: 1.25rem;
  position: relative;
}
body::before {
  content:''; position: fixed; inset:0;
  background: linear-gradient(0.25turn, var(--primary-color), var(--secondary-color));
  opacity:0.3;
  z-index:-1;
  pointer-events: none;
}
.container { max-width: var(--max-width); margin:0 auto; }
.header {
  text-align:center;
  margin-bottom:0.625rem;
  color: var(--primary-color);
  font-size:1.3rem;
  font-weight:bold;
  padding:1.25rem 1.25rem 3.75rem;
  background:url('calor.png') center/contain no-repeat;
}
.table-container {
  max-width: var(--max-width);
  overflow-x:auto;
  margin:0 auto 1.25rem;
  background: var(--bg-white);
  border-radius: var(--border-radius); /* remplacé */
  box-shadow: 0 0.25rem 0.75rem var(--shadow);
}
table { width:100%; border-collapse: collapse; min-width:43.75rem; }
th, td { padding:0.375rem 0.5rem; border-bottom:1px solid var(--border-light); text-align:left; white-space: nowrap; }
th { background: var(--header-bg); font-weight:600; position:sticky; top:0; z-index:10; }

caption { caption-side: top; text-align:left; font-weight:bold; margin-bottom:0.5rem; }
#tbl-cat th:nth-child(1), #tbl-cat th:nth-child(8) { background: var(--grey); color:#111; }
#tbl-cat th:nth-child(2), #tbl-cat th:nth-child(3), #tbl-cat th:nth-child(4) { background: var(--primary-color); color:#fff; }
#tbl-cat th:nth-child(5), #tbl-cat th:nth-child(6), #tbl-cat th:nth-child(7) { background: var(--secondary-color); color:#fff; }

tbody tr:nth-child(even){ background: var(--bg-light); }
tbody tr:nth-child(even) { background: var(--bg-light); }
.muted { color:#777; }

/* Flexbox pour les tableaux Âges */
.ages-container {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap; /* empile sur petit écran */
}
.ages-table {
  flex: 1; /* prend l’espace disponible équitablement */
  min-width: 280px; /* garantit la lisibilité sur mobile */
}

@media (max-width:768px){
  .header { margin-bottom:0.625rem; padding:0rem 0rem 1.5rem; font-size:1rem; }
  table { min-width:auto; font-size:0.85rem; }
  th, td { padding:0.375rem 0.5rem; }
  .ages-container { flex-direction: column; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">STATISTIQUES CALOR RUN</div>

  <!-- Tableau 1 : Répartition par catégories -->
  <div class="table-container">
    <table id="tbl-cat">
      <caption>Répartition par catégories</caption>
      <thead>
        <tr>
          <th>Catégorie</th>
          <th>Femmes (10km)</th>
          <th>Hommes (10km)</th>
          <th>Total (10km)</th>
          <th>Femmes (20km)</th>
          <th>Hommes (20km)</th>
          <th>Total (20km)</th>
          <th>Total général</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="8" class="muted">Chargement…</td></tr></tbody>
    </table>
  </div>

  <!-- Tableau 2 : Âges -->
  <div class="table-container ages-container">
    <div class="ages-table">
      <table id="tbl-age-10">
        <caption>-/+ Âgés - 10 km</caption>
        <thead>
          <tr>
            <th>Dossard</th><th>Prénom</th><th>Nom</th><th>Âge</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="4" class="muted">Chargement…</td></tr></tbody>
      </table>
    </div>
    <div class="ages-table">
      <table id="tbl-age-20">
        <caption>-/+ Âgés - 20 km</caption>
        <thead>
          <tr>
            <th>Dossard</th><th>Prénom</th><th>Nom</th><th>Âge</th>
          </tr>
        </thead>
        <tbody><tr><td colspan="4" class="muted">Chargement…</td></tr></tbody>
      </table>
    </div>
  </div>

  <!-- Tableau 3 : Classement des clubs -->
  <div class="table-container">
    <table id="tbl-clubs">
      <caption>Clubs les plus représentés</caption>
      <thead>
        <tr>
          <th>Rang</th>
          <th>Club</th>
          <th>Participants</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="3" class="muted">Chargement…</td></tr></tbody>
    </table>
  </div>
</div>

<div id="err" class="error" style="display:none;color:red;text-align:center;margin-top:1rem;"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain:"calor-run.firebaseapp.com",
  databaseURL:"https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"calor-run",
  storageBucket:"calor-run.firebasestorage.app",
  messagingSenderId:"329949291334",
  appId:"1:329949291334:web:c71ef20268c609cf953b47"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const el = {
  cat: document.querySelector('#tbl-cat tbody'),
  age10: document.querySelector('#tbl-age-10 tbody'),
  age20: document.querySelector('#tbl-age-20 tbody'),
  clubs: document.querySelector('#tbl-clubs tbody'),
  err: document.getElementById('err')
};

const orderCat = ['CA','JU','ES','SE','M0','M1','M2','M3','M4','M5','M6','M7','M8','M9','M10'];

function parseDate(d){if(!d)return null;const dt=new Date(d);return isNaN(dt.getTime())?null:dt;}
function computeAge(d){if(!d)return null;const today=new Date();let a=today.getFullYear()-d.getFullYear();if(today.getMonth()<d.getMonth()||(today.getMonth()===d.getMonth()&&today.getDate()<d.getDate()))a--;return a;}

function renderCats(body, data){
  const counts = {10:{},20:{}};
  Object.values(data||{}).forEach(p=>{
    const course = Number(p.course)||0;
    const cat = p.categorie||'—';
    const genre = (p.genre||'').toLowerCase();
    counts[course][cat] = counts[course][cat]||{f:0,h:0};
    if(genre==='f' || genre==='femme') counts[course][cat].f++;
    else counts[course][cat].h++;
  });

  const rows=[];
  let tot10f=0,tot10h=0,tot20f=0,tot20h=0;
  orderCat.forEach(cat=>{
    const v10 = counts[10][cat]||{f:0,h:0};
    const v20 = counts[20][cat]||{f:0,h:0};
    const t10 = v10.f+v10.h;
    const t20 = v20.f+v20.h;
    const total = t10+t20;
    rows.push(`<tr>
      <td>${cat}</td>
      <td>${v10.f}</td><td>${v10.h}</td><td>${t10}</td>
      <td>${v20.f}</td><td>${v20.h}</td><td>${t20}</td>
      <td>${total}</td>
    </tr>`);
    tot10f+=v10.f; tot10h+=v10.h;
    tot20f+=v20.f; tot20h+=v20.h;
  });

  const tot10 = tot10f+tot10h;
  const tot20 = tot20f+tot20h;
  const grandTotal = tot10+tot20;

  rows.push(`<tr style="font-weight:700">
    <td>Totaux</td>
    <td>${tot10f} (${Math.round(100*tot10f/tot10||0)}%)</td>
    <td>${tot10h} (${Math.round(100*tot10h/tot10||0)}%)</td>
    <td>${tot10}</td>
    <td>${tot20f} (${Math.round(100*tot20f/tot20||0)}%)</td>
    <td>${tot20h} (${Math.round(100*tot20h/tot20||0)}%)</td>
    <td>${tot20}</td>
    <td>${grandTotal}</td>
  </tr>`);

  body.innerHTML = rows.join('');
}

function renderAges(body10, body20, data){
  const ages={10:{oldest:null,youngest:null},20:{oldest:null,youngest:null}};
  Object.values(data||{}).forEach(p=>{
    const course = Number(p.course)||0;
    const birth = parseDate(p.date_naiss);
    const age = computeAge(birth);
    if(!birth||age===null) return;
    const pack={dossard:p.dossard||'',prenom:p.prenom||'',nom:p.nom||'',age};
    if(course===10){
      if(!ages[10].oldest||age>ages[10].oldest.age) ages[10].oldest=pack;
      if(!ages[10].youngest||age<ages[10].youngest.age) ages[10].youngest=pack;
    }
    if(course===20){
      if(!ages[20].oldest||age>ages[20].oldest.age) ages[20].oldest=pack;
      if(!ages[20].youngest||age<ages[20].youngest.age) ages[20].youngest=pack;
    }
  });

  function buildRows(a){return [a.oldest,a.youngest].filter(Boolean).map(p=>`<tr><td>${p.dossard}</td><td>${p.prenom}</td><td>${p.nom}</td><td>${p.age} ans</td></tr>`).join('')||'<tr><td colspan="4" class="muted">Aucune donnée.</td></tr>'; }
  body10.innerHTML=buildRows(ages[10]);
  body20.innerHTML=buildRows(ages[20]);
}

function renderClubs(body, data){
  const clubsCount = {};
  Object.values(data||{}).forEach(p=>{
    const club = (p.club || '').trim(); // <- trim pour enlever espaces
    if(!club) return; // <- ignorer si vide
    clubsCount[club] = (clubsCount[club]||0) + 1;
  });

  // Convertir en tableau et filtrer uniquement les clubs avec participants
  const filteredClubs = Object.entries(clubsCount).filter(([club, count]) => count > 0);

  // Trier : nombre décroissant, puis alphabétique
  const sortedClubs = filteredClubs.sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0]));

  // Générer les lignes
  const rows = sortedClubs.map((c,i)=>`<tr><td>${i+1}</td><td>${c[0]}</td><td>${c[1]}</td></tr>`);

  body.innerHTML = rows.join('') || '<tr><td colspan="3" class="muted">Aucune donnée.</td></tr>';
}

function showError(msg){el.err.style.display='block'; el.err.textContent=msg;}

db.ref('participants').on('value',snap=>{
  try{
    const data = snap.val()||{};
    renderCats(el.cat,data);
    renderAges(el.age10,el.age20,data);
    renderClubs(el.clubs,data);
  }catch(e){
    console.error(e);
    showError("Erreur traitement : "+e.message);
  }
},err=>{console.error(err);showError("Erreur Firebase : "+err.message);});
</script>
</body>
</html>
