<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Scanner Dossards</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
body { margin:0;font-family:sans-serif;background:#000;color:#fff;overflow:hidden; }
#reader{position:absolute;top:0;left:0;right:0;bottom:30vh;}
#reader video{object-fit:cover;width:100%;height:100%;}
#current-scan{position:absolute;bottom:28vh;left:0;right:0;font-size:3em;font-weight:bold;text-align:center;background:rgba(0,0,0,0.6);padding:10px;}
#counter{position:absolute;bottom:10px;left:0;right:0;font-size:2em;text-align:center;background:rgba(255,255,255,0.2);padding:10px;cursor:pointer;}
#results{position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:none;padding:20px;text-align:center;overflow-y:auto;}
#back-button{background:#28a745;color:white;border:none;padding:10px 20px;font-size:1.2em;border-radius:8px;margin-bottom:20px;}
#history-list .scan-entry{font-size:2em;margin:10px auto;background:#fff;color:#000;padding:10px 20px;border-radius:6px;display:inline-block;}
</style>
</head>
<body>
<div id="reader"></div>
<div id="current-scan">---</div>
<div id="counter">Historique</div>
<div id="results">
<button id="back-button">Retour</button>
<div id="history-list"></div>
</div>
<audio id="beep-sound" src="beep.mp3" preload="auto"></audio>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain:"calor-run.firebaseapp.com",
  databaseURL:"https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"calor-run",
  storageBucket:"calor-run.appspot.com",
  messagingSenderId:"329949291334",
  appId:"1:329949291334:web:c71ef20268c609cf953b47"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const auth = firebase.auth();

let scannedCodes = new Set(JSON.parse(localStorage.getItem('scannedCodes')||"[]"));
let lastScan="", lastScanTime=0, maxDossard;
const beepSound=document.getElementById('beep-sound');
const currentScanDiv=document.getElementById('current-scan');
const counterDiv=document.getElementById('counter');
const resultsDiv=document.getElementById('results');
const backButton=document.getElementById('back-button');
const historyList=document.getElementById('history-list');

counterDiv.onclick=()=>{ resultsDiv.style.display='block'; };
backButton.onclick=()=>{ resultsDiv.style.display='none'; };

function updateCounter(){ counterDiv.textContent="Historique"; }

function addScanToHistory(code){
  const entry=document.createElement('div');
  entry.className='scan-entry';
  entry.textContent=code;
  historyList.prepend(entry);
  if(historyList.childNodes.length>100) historyList.removeChild(historyList.lastChild);
}

function canScan(code){
  const now=Date.now();
  if(scannedCodes.has(code)) return false;
  if(code===lastScan && (now-lastScanTime)<3000) return false;
  lastScan=code;
  lastScanTime=now;
  return true;
}

function sendToFirebase(code){
  const codeInt=parseInt(code,10);
  if(!maxDossard||isNaN(codeInt)||codeInt<1||codeInt>maxDossard) return;
  if(!canScan(code)) return;

  scannedCodes.add(code);
  localStorage.setItem('scannedCodes',JSON.stringify(Array.from(scannedCodes)));
  currentScanDiv.textContent=code;
  addScanToHistory(code);
  updateCounter();
  beepSound.play();
  navigator.vibrate?.(100);
  setTimeout(()=>currentScanDiv.textContent="---",2000);

  // transaction pour éviter doublons et permettre offline
  const ref=database.ref('scan_dossards/'+code);
  ref.transaction(current=>current===null?{dateTime:Date.now()}:undefined);
}

function loadInitialScans(limit=50){
  scannedCodes.forEach(code=>addScanToHistory(code));
  database.ref('scan_dossards').orderByKey().limitToLast(limit).once('value',snapshot=>{
    snapshot.forEach(child=>{
      if(!scannedCodes.has(child.key)){
        scannedCodes.add(child.key);
        localStorage.setItem('scannedCodes',JSON.stringify(Array.from(scannedCodes)));
        addScanToHistory(child.key);
      }
    });
  });

  // écoute temps réel des nouveaux scans
  database.ref('scan_dossards').limitToLast(1).on('child_added',snapshot=>{
    const code=snapshot.key;
    if(!scannedCodes.has(code)){
      scannedCodes.add(code);
      localStorage.setItem('scannedCodes',JSON.stringify(Array.from(scannedCodes)));
      addScanToHistory(code);
    }
  });
}

let qrInstance;
function startCamera(){
  Html5Qrcode.getCameras().then(cameras=>{
    if(!cameras.length) return;
    const rear=cameras.find(c=>c.label.toLowerCase().includes("back"))||cameras[0];
    if(!qrInstance) qrInstance=new Html5Qrcode("reader");
    qrInstance.start(
      {deviceId:{exact:rear.id}},
      {fps:30,qrbox:{width:300,height:300},disableFlip:true,aspectRatio:1.0},
      sendToFirebase,
      ()=>{}
    );
  });
}

function startApp(){ loadInitialScans(); startCamera(); }

database.ref('data/participants').once('value').then(snapshot=>{
  const val=snapshot.val();
  if(val&&!isNaN(parseInt(val,10))) maxDossard=parseInt(val,10);
  console.log("Max dossards:",maxDossard);
});

auth.onAuthStateChanged(user=>{ if(user) startApp(); });
auth.signInAnonymously().catch(err=>alert("Erreur d'authentification: "+err.message));
</script>
</body>
</html>
