<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Live Calor Run</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏱️</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono:wght@400&display=swap" rel="stylesheet">
<style>
:root {
    --primary-color: #215E99;
    --secondary-color: #E61780;
    --bg-white: #fff;
    --bg-light: #f9f9f9;
    --shadow: rgba(0, 0, 0, 0.15);
    --border-radius: 0.5rem;
    --max-width: 62.5rem;
    --text-dark: #333;
    --border-light: #ddd;
    --header-bg: #e0e0e0;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    line-height: 1.5;
    color: var(--text-dark);
    min-height: 100vh;
    padding: 1.25rem;
    position: relative;
}
body::before {
  content:''; position: fixed; inset:0;
  background: linear-gradient(0.25turn, var(--primary-color), var(--secondary-color));
  opacity:0.3;
  z-index:-1;
  pointer-events: none;
}
.container { max-width: var(--max-width); margin: 0 auto; }
.header {
  text-align:center;
  margin-bottom:0.625rem;
  color: var(--primary-color);
  font-size:1.3rem;
  font-weight:bold;
  padding:1.25rem 1.25rem 3.75rem;
  background:url('calor.png') center/contain no-repeat;
}
.chrono-time {
    font-family: 'Share Tech Mono', monospace;
    font-variant-numeric: tabular-nums;
    color: var(--primary-color);
}
.chrono-time.paused { opacity: 0.7; }
.counter-line { text-align: center; margin-bottom: 15px; font-size: 1rem; }
.counter-10km { color: var(--primary-color); cursor:pointer; }
.counter-20km { color: var(--secondary-color); cursor:pointer; }
.counter-total { color: #000; }
.counter-error { animation: blinker 2s linear infinite; color: red; }
@keyframes blinker { 50% { opacity: 0; } }

.table-container { width: 96vw; max-width: 1400px; overflow-x:auto; margin:1rem auto; background: var(--bg-white); border-radius: var(--border-radius); box-shadow: 0 0.25rem 0.75rem var(--shadow); }
table { width: 100%; border-collapse: collapse; min-width:300px; margin-bottom:2rem; }
th, td { padding:0.375rem 0.5rem; border-bottom:1px solid var(--border-light); text-align:left; }
th { background: var(--header-bg); font-weight:600; position:sticky; top:0; z-index:10; }
tbody tr:nth-child(even){ background: var(--bg-light); }
.text-center { text-align:center; }
.loading { text-align:center; padding:1.25rem 0; font-size:1rem; }
.hidden { display:none; }

.filter-bar { text-align:center; margin-bottom:1rem; }
.filter-bar select, .filter-bar button { margin:0 0.25rem; padding:0.25rem 0.5rem; font-size:0.9rem; }

@media (max-width: 768px) {
    .header { margin-bottom:0.625rem; padding:0rem 0rem 1.5rem; font-size:0.75rem; }
    .counter-line { margin-bottom: 5px; font-size:0.75rem; }
    .table-container { width: 98vw; overflow-x: auto; }
    table { width: auto; font-size: 0.85rem; }
    th, td { padding:0.375rem 0.5rem; }
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="chrono-time paused" id="chrono-time">
            <span id="chrono-text">--:--:--</span>
        </div>
    </div>
    <div id="loading" class="loading">Connexion...</div>
    <div id="compteurs" class="counter-line hidden">
        <span class="counter-10km">10 km : 0</span>
        <span>•</span>
        <span class="counter-20km">20 km : 0</span>
        <span> • </span>
        <span class="counter-total">Total : 0</span>
    </div>

    <div class="filter-bar hidden" id="filter-bar">
        <button data-course="10km" class="filter-course">10 km</button>
        <button data-course="20km" class="filter-course">20 km</button>
        <select id="filter-cat">
            <option value="">Toutes catégories</option>
        </select>
    </div>
</div>

<div class="table-container hidden" id="tables">
    <h3>Podium Hommes</h3>
    <table id="table-homme">
        <thead>
            <tr>
                <th>Podium</th>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Temps</th>
                <th>Catégorie</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <h3>Podium Femmes</h3>
    <table id="table-femme">
        <thead>
            <tr>
                <th>Podium</th>
                <th>Nom</th>
                <th>Prénom</th>
                <th>Temps</th>
                <th>Catégorie</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
'use strict';

const FIREBASE_CONFIG = {
    apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
    authDomain: "calor-run.firebaseapp.com",
    databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "calor-run",
    storageBucket: "calor-run.firebasestorage.app",
    messagingSenderId: "329949291334",
    appId: "1:329949291334:web:c71ef20268c609cf953b47",
    measurementId: "G-YVQPW6JGPK"
};

const COURSE_ALIASES = {
    '10': '10km', '10km': '10km', '10 km': '10km',
    '20': '20km', '20km': '20km', '20 km': '20km'
};

const elements = {
    chronoTime: document.getElementById('chrono-time'),
    chronoText: document.getElementById('chrono-text'),
    loading: document.getElementById('loading'),
    compteurs: document.getElementById('compteurs'),
    counter10km: document.querySelector('.counter-10km'),
    counter20km: document.querySelector('.counter-20km'),
    counterTotal: document.querySelector('.counter-total'),
    filterBar: document.getElementById('filter-bar'),
    filterCat: document.getElementById('filter-cat'),
    tables: document.getElementById('tables'),
    tableHomme: document.querySelector('#table-homme tbody'),
    tableFemme: document.querySelector('#table-femme tbody')
};

let departureTimestamp = null;
let participants = {};
let scans = {};
let chronoInterval = null;

const app = firebase.initializeApp(FIREBASE_CONFIG);
const db = firebase.database();

function formatTime(ms) {
    const totalSeconds = Math.floor(Math.abs(ms) / 1000);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
}

function startChrono() {
    clearInterval(chronoInterval);
    if(!departureTimestamp){
        elements.chronoText.textContent="--:--:--";
        elements.chronoTime.classList.add('paused');
        return;
    }
    elements.chronoTime.classList.remove('paused');
    const updateChrono = ()=>{ elements.chronoText.textContent = formatTime(Date.now()-departureTimestamp); };
    updateChrono();
    chronoInterval = setInterval(updateChrono,1000);
}

function getTop3Filtered(courseFilter, catFilter, genreFilter){
    const classement = Object.keys(scans).map(dossard=>{
        const scan=scans[dossard], p=participants[dossard]||{};
        const tempsMs = new Date(scan.dateTime).getTime()-departureTimestamp;
        return {nom:p.nom||'', prenom:p.prenom||'', tempsMs, tempsStr: formatTime(tempsMs), categorie:p.categorie||'', course:p.course||'', genre:p.genre||''};
    }).filter(p=>{
        const courseNorm = COURSE_ALIASES[p.course]||p.course;
        const catOk = !catFilter || p.categorie === catFilter;
        const courseOk = !courseFilter || courseNorm === courseFilter;
        const genreOk = !genreFilter || p.genre===genreFilter;
        return catOk && courseOk && genreOk;
    }).sort((a,b)=>a.tempsMs-b.tempsMs); // meilleur temps premier
    return classement.slice(0,3);
}

function renderTable(tbody, data){
    tbody.innerHTML='';
    ['1er','2ème','3ème'].forEach((podium,i)=>{
        const p = data[i];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="text-center">${podium}</td>
                        <td>${p?p.nom:''}</td>
                        <td>${p?p.prenom:''}</td>
                        <td>${p?p.tempsStr:''}</td>
                        <td>${p?p.categorie:''}</td>`;
        tbody.appendChild(tr);
    });
}

function updateTables(){
    const catFilter = elements.filterCat.value;
    const courseFilter = window.selectedCourse || '';
    const topH = getTop3Filtered(courseFilter, catFilter, 'H');
    const topF = getTop3Filtered(courseFilter, catFilter, 'F');
    renderTable(elements.tableHomme, topH);
    renderTable(elements.tableFemme, topF);
}

function populateCategories(){
    const cats = new Set(Object.values(participants).map(p=>p.categorie).filter(Boolean));
    elements.filterCat.innerHTML='<option value="">Toutes catégories</option>';
    cats.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; elements.filterCat.appendChild(opt); });
}

db.ref('data/depart_course').on('value', snapshot=>{
    departureTimestamp=snapshot.exists()?new Date(snapshot.val()).getTime():null;
    if(departureTimestamp) startChrono();
});

db.ref('participants').on('value', snapshot=>{
    participants=snapshot.val()||{};
    elements.filterBar.classList.remove('hidden');
    elements.tables.classList.remove('hidden');
    populateCategories();
    updateTables();
});

db.ref('scan_dossards').on('value', snapshot=>{
    scans=snapshot.val()||{};
    updateTables();
});

elements.filterCat.addEventListener('change', updateTables);
document.querySelectorAll('.filter-course').forEach(btn=>{
    btn.addEventListener('click', e=>{
        window.selectedCourse = e.target.dataset.course;
        updateTables();
    });
});

window.addEventListener('beforeunload', ()=>{ if(chronoInterval) clearInterval(chronoInterval); });
</script>
</body>
</html>
