<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Podiums Calor Run</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü•á</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono:wght@400&display=swap" rel="stylesheet">
<style>
:root {
  --primary-color: #215E99;
  --secondary-color: #E61780;
  --bg-white: #fff;
  --bg-light: #f9f9f9;
  --shadow: rgba(0,0,0,0.15);
  --border-radius: 0.5rem;
  --max-width: 62.5rem;
  --text-dark: #333;
  --border-light: #ddd;
  --header-bg: #e0e0e0;
}
* { box-sizing: border-box; margin:0; padding:0; }
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  line-height: 1.5;
  color: var(--text-dark);
  min-height: 100vh;
  padding: 1.25rem;
  position: relative;
}
body::before {
  content:''; position: fixed; inset:0;
  background: linear-gradient(0.25turn, var(--primary-color), var(--secondary-color));
  opacity:0.3;
  z-index:-1;
  pointer-events: none;
}
.container { max-width: var(--max-width); margin:0 auto; }
.header {
  text-align:center;
  margin-bottom:0.625rem;
  color: var(--primary-color);
  font-size:1.3rem;
  font-weight:bold;
  padding:1.25rem 1.25rem 3.75rem;
  background:url('calor.png') center/contain no-repeat;
}
.table-container {
  max-width: var(--max-width);
  overflow-x:auto;
  margin:0 auto 1.25rem;
  background: var(--bg-white);
  border-radius: var(--border-radius);
  box-shadow: 0 0.25rem 0.75rem var(--shadow);
  padding: 0.5rem;
}
.table-title {
  font-weight: bold;
  font-size: 1rem;
  margin-bottom: 0.5rem;
  color: var(--primary-color);
}
table { width:100%; border-collapse: collapse; min-width:43.75rem; }
th, td { padding:0.375rem 0.5rem; border-bottom:1px solid var(--border-light); text-align:left; white-space: nowrap; }
th { background: var(--header-bg); font-weight:600; position:sticky; top:0; z-index:10; }
tbody tr:nth-child(even){ background: var(--bg-light); }
.muted { color:#777; }
.filter-container { text-align:center; margin-bottom:1rem; }
.filter-container span { cursor:pointer; margin:0 0.5rem; color:var(--primary-color); font-weight:bold; }
.filter-container select { padding:0.25rem; margin-left:0.5rem; }
@media (max-width:768px){
  .header { margin-bottom:0.625rem; padding:0rem 0rem 1.5rem; font-size:1rem; }
  table { min-width:auto; font-size:0.85rem; }
  th, td { padding:0.375rem 0.5rem; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">PODIUMS CALOR RUN</div>

  <!-- Filtres -->
  <div class="filter-container">
    Course : <span id="filter10">10 km</span> / <span id="filter20">20 km</span>
    Cat√©gorie : 
    <select id="filterCat"><option value="Toutes">Toutes</option></select>
  </div>

  <!-- Tableau Podium Hommes -->
  <div class="table-container">
    <div class="table-title">Podium Hommes</div>
    <table id="tblPodH">
      <thead>
        <tr><th>Podium</th><th>Nom</th><th>Pr√©nom</th><th>Temps</th><th>Cat</th></tr>
      </thead>
      <tbody><tr><td colspan="5" class="muted">Chargement‚Ä¶</td></tr></tbody>
    </table>
  </div>

  <!-- Tableau Podium Femmes -->
  <div class="table-container">
    <div class="table-title">Podium Femmes</div>
    <table id="tblPodF">
      <thead>
        <tr><th>Podium</th><th>Nom</th><th>Pr√©nom</th><th>Temps</th><th>Cat</th></tr>
      </thead>
      <tbody><tr><td colspan="5" class="muted">Chargement‚Ä¶</td></tr></tbody>
    </table>
  </div>
</div>

<div id="err" class="error" style="display:none;color:red;text-align:center;margin-top:1rem;"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey:"AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
  authDomain:"calor-run.firebaseapp.com",
  databaseURL:"https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"calor-run",
  storageBucket:"calor-run.firebasestorage.app",
  messagingSenderId:"329949291334",
  appId:"1:329949291334:web:c71ef20268c609cf953b47"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const el = {
  filter10: document.getElementById('filter10'),
  filter20: document.getElementById('filter20'),
  filterCat: document.getElementById('filterCat'),
  podH: document.querySelector('#tblPodH tbody'),
  podF: document.querySelector('#tblPodF tbody'),
  err: document.getElementById('err')
};

let currentCourse = 10;
let currentCat = 'Toutes';
let participantsData = [];
let scanTimesData = [];

function formatTime(ts){
  if(!ts) return '';
  const s = Math.floor(ts/1000);
  const h = Math.floor(s/3600);
  const m = Math.floor((s%3600)/60);
  const sec = s%60;
  return (h>0?h+'h ':'') + (m>0?m+'m ':'') + sec+'s';
}

function renderPodiums(){
  const podH = [];
  const podF = [];
  participantsData.forEach(p => {
    if(!p.genre || !p.categorie) return;
    if(currentCat !== 'Toutes' && p.categorie !== currentCat) return;

    let course = 0;
    if(typeof p.course === 'number') course = p.course;
    else if(typeof p.course === 'string'){
      const m = p.course.match(/(\d{1,3})/);
      course = m ? Number(m[1]) : 0;
    }
    if(course !== currentCourse) return;

    const scan = scanTimesData.find(s => s.dossard == p.dossard);
    if(!scan || scan.temps == null) return;

    let temps = Number(scan.temps);
    if(temps < 1000000) temps *= 1000;

    const entry = {nom:p.nom||'', prenom:p.prenom||'', cat:p.categorie, temps};
    if(p.genre.toLowerCase().startsWith('f')) podF.push(entry);
    else podH.push(entry);
  });

  podH.sort((a,b)=>a.temps-b.temps);
  podF.sort((a,b)=>a.temps-b.temps);

  function fillTable(body, arr){
    const podium = ['1er','2nd','3√®me'];
    const rows = [];
    for(let i=0;i<3;i++){
      const e = arr[i];
      rows.push(`<tr>
        <td>${podium[i]}</td>
        <td>${e?e.nom:''}</td>
        <td>${e?e.prenom:''}</td>
        <td>${e?formatTime(e.temps):''}</td>
        <td>${e?e.cat:''}</td>
      </tr>`);
    }
    body.innerHTML = rows.join('');
  }
  fillTable(el.podH, podH);
  fillTable(el.podF, podF);
}

el.filter10.addEventListener('click',()=>{currentCourse=10; renderPodiums();});
el.filter20.addEventListener('click',()=>{currentCourse=20; renderPodiums();});
el.filterCat.addEventListener('change',()=>{currentCat=el.filterCat.value; renderPodiums();});

function showError(msg){el.err.style.display='block'; el.err.textContent=msg;}

// Charger participants et scan_dossards
db.ref('participants').on('value',snap=>{
  participantsData = Object.values(snap.val()||{});
  // remplir filtre cat√©gories
  const cats = Array.from(new Set(participantsData.map(p=>p.categorie).filter(c=>c))).sort();
  el.filterCat.innerHTML = '<option value="Toutes">Toutes</option>'+cats.map(c=>`<option>${c}</option>`).join('');
  renderPodiums();
},err=>showError("Erreur participants : "+err.message));

db.ref('scan_dossards').on('value',snap=>{
  scanTimesData = Object.values(snap.val()||{});
  renderPodiums();
},err=>showError("Erreur scan_dossards : "+err.message));
</script>

</body>
</html>
