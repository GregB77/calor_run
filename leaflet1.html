<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profil de pente interactif</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html,body { height:100%; margin:0; }
    #map { position:absolute; top:0; bottom:0; right:0; left:0; }

    /* Panneau flottant */
    #chart-container {
      position:absolute;
      bottom:20px;
      right:20px;
      width:620px;
      height:240px;
      background:white;
      border-radius:10px;
      box-shadow:0 2px 8px rgba(0,0,0,0.25);
      padding:10px;
      z-index:9999;
      display:none;
      cursor:grab;
    }

    #panel-toggle, #panel-detach {
      position:absolute;
      z-index:9999;
      background:white;
      padding:6px 10px;
      border-radius:6px;
      box-shadow:0 2px 5px rgba(0,0,0,0.3);
      cursor:pointer;
      font-family:Arial;
    }

    #panel-toggle { bottom:270px; right:20px; }
    #panel-detach { bottom:20px; right:650px; display:none; }

    canvas { width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="panel-toggle">Ouvrir le profil</div>
  <div id="panel-detach">Déplacer</div>

  <div id="chart-container"><canvas id="elevChart"></canvas></div>

  <script>
    const map = new maplibregl.Map({
      container:'map',
      style:{ version:8,
        sources:{ 'osm':{ type:'raster', tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize:256 }},
        layers:[{ id:'osm', type:'raster', source:'osm' }]
      },
      center:[0,0], zoom:2
    });

    map.addControl(new maplibregl.NavigationControl());

    const GEOJSON_URL="trail_10km.geojson";

    fetch(GEOJSON_URL).then(r=>r.json()).then(geojson=>{
      map.addSource('trail',{type:'geojson',data:geojson});
      map.addLayer({ id:'trail-line', type:'line', source:'trail', paint:{'line-color':'#e91e63','line-width':4} });

      const f=geojson.features.find(f=>f.geometry.type==='LineString');
      const coords=f.geometry.coordinates;

      /* Compute distances + slopes */
      const distances=[0];
      const slopes=[0];
      for(let i=1;i<coords.length;i++){
        const dx=(coords[i][0]-coords[i-1][0])*111320*Math.cos(coords[i][1]*Math.PI/180);
        const dy=(coords[i][1]-coords[i-1][1])*110540;
        const dist=Math.sqrt(dx*dx+dy*dy);
        distances.push(distances[i-1]+dist);

        const dh=(coords[i][2]||0)-(coords[i-1][2]||0);
        slopes.push(dist>0?(dh/dist):0);
      }

      const kmLabels = distances.map(d => (d/1000));
      const pctSlopes = slopes.map(s => s*100);

      const ctx=document.getElementById('elevChart').getContext('2d');

      const chart=new Chart(ctx,{
        type:'line',
        data:{ labels:kmLabels, datasets:[{
          label:'Pente (%)',
          data:pctSlopes,
          borderWidth:2,
          fill:true,
          backgroundColor:(c)=>{
            const s=c.raw;
            if(s>15) return 'rgba(255,0,0,0.4)';
            if(s>5) return 'rgba(255,165,0,0.4)';
            return 'rgba(0,128,0,0.4)';
          },
          segment:{ borderColor:(ctx)=>{
            const s=pctSlopes[ctx.p0DataIndex];
            if(s>15) return 'red';
            if(s>5) return 'orange';
            return 'green';
          }}
        }]},
        options:{
          responsive:true,
          interaction:{mode:'nearest',intersect:false},
          plugins:{ tooltip:{ callbacks:{
            label:(ctx)=> `Pente: ${ctx.raw.toFixed(1)} %`,
            title:(ctx)=> `Distance: ${ctx[0].parsed.x.toFixed(1)} km`
          }}},
          scales:{
            x:{ title:{display:true,text:'Distance (km)'}, ticks:{callback:(v)=>Number(v).toFixed(0)}},
            y:{ title:{display:true,text:'Pente (%)'} }
          },
          onHover:(ev,items)=>{
            if(items.length){
              const i=items[0].index;
              const lnglat=[coords[i][0],coords[i][1]];
              if(window.chartMarker) chartMarker.remove();
              window.chartMarker=new maplibregl.Marker({color:'#000'}).setLngLat(lnglat).addTo(map);
              map.easeTo({center:lnglat,duration:150});
            }
          }
        }
      });

      /* Carte → graphique */
      map.on('mousemove','trail-line',e=>{
        let nearest=0,mind=Infinity;
        coords.forEach((c,i)=>{
          const dx=c[0]-e.lngLat.lng;
          const dy=c[1]-e.lngLat.lat;
          const d=dx*dx+dy*dy;
          if(d<mind){mind=d;nearest=i;}
        });
        chart.setActiveElements([{datasetIndex:0,index:nearest}]);
        chart.tooltip.setActiveElements([{datasetIndex:0,index:nearest}]);
        chart.update();
      });

      /* Ouvrir/fermer */
      const panel=document.getElementById('chart-container');
      const toggle=document.getElementById('panel-toggle');
      const detach=document.getElementById('panel-detach');

      toggle.onclick=()=>{
        const v=(panel.style.display==='block');
        panel.style.display=v?'none':'block';
        detach.style.display=v?'none':'block';
        toggle.textContent=v?'Ouvrir le profil':'Fermer le profil';
      };

      /* Déplacement du panneau */
      let dragging=false, offsetX=0, offsetY=0;
      detach.onclick=()=>{ dragging=!dragging; detach.textContent = dragging?"Fixer":"Déplacer"; };

      document.addEventListener('mousemove',e=>{
        if(dragging){
          panel.style.left = (e.clientX - 300) + "px";
          panel.style.top = (e.clientY - 20) + "px";
        }
      });

    });
  </script>
</body>
</html>
