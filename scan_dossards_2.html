<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner Dossards</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <style>
    :root {
      --primary-color: #215E99;
      --secondary-color: #E61780;
      --button-bg: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      --button-hover-bg: linear-gradient(to right, var(--primary-color), var(--secondary-color));
    }
    body { margin: 0; font-family: sans-serif; background: #000; color: #fff; overflow: hidden; }
    #reader { position: absolute; top:0; left:0; right:0; bottom:30vh; }
    #reader video { object-fit: cover; width: 100%; height: 100%; }
    #current-scan { position: absolute; bottom:28vh; left:0; right:0; font-size:4em; font-weight:bold; text-align:center; background:rgba(0,0,0,0.6); padding:10px; }
    .button { display:block; width:100%; font-size:1.5em; text-align:center; padding:15px 0; cursor:pointer; background:var(--button-bg); color:#fff; border:none; transition:background 0.3s ease; }
    .button:hover { background: var(--button-hover-bg); }
    #counter { position:absolute; bottom:0; left:0; right:0; }
    #back-button { margin-bottom:20px; }
    #results { position:absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.9); display:none; padding:20px; text-align:center; overflow-y:auto; }
    #history-list { display:flex; flex-wrap:wrap; justify-content:center; gap:5px; }
    .scan-entry { font-size:1.5em; width:3em; height:3em; display:flex; align-items:center; justify-content:center; font-family:monospace; background:#fff; color:#000; border-radius:6px; box-sizing:border-box; }
  </style>
</head>
<body>
  <div id="reader"></div>
  <div id="current-scan">---</div>
  <div id="counter" class="button">HISTORIQUE</div>

  <div id="results">
    <button id="back-button" class="button">RETOUR</button>
    <div id="history-list"></div>
  </div>

  <audio id="beep-sound" src="beep.mp3" preload="auto"></audio>

  <script>
    // ------------------- CONFIG FIREBASE -------------------
    const firebaseConfig = {
      apiKey: "AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",
      authDomain: "calor-run.firebaseapp.com",
      databaseURL: "https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "calor-run",
      storageBucket: "calor-run.appspot.com",
      messagingSenderId: "329949291334",
      appId: "1:329949291334:web:c71ef20268c609cf953b47"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    // ------------------- DOM -------------------
    const beepSound = document.getElementById('beep-sound');
    const currentScanDiv = document.getElementById('current-scan');
    const counterDiv = document.getElementById('counter');
    const resultsDiv = document.getElementById('results');
    const backButton = document.getElementById('back-button');
    const historyList = document.getElementById('history-list');

    // ------------------- STATE -------------------
    let scannedCodes = new Set(JSON.parse(localStorage.getItem('scannedCodes') || "[]"));
    let pendingScans = JSON.parse(localStorage.getItem('pendingScans') || "[]");
    let lastScan = "", lastScanTime = 0, maxDossard;
    let qrScanner;

    // ------------------- UI -------------------
    counterDiv.onclick = () => resultsDiv.style.display = 'block';
    backButton.onclick = () => resultsDiv.style.display = 'none';

    function saveScannedCodes() { localStorage.setItem('scannedCodes', JSON.stringify(Array.from(scannedCodes))); }
    function savePendingScans() { localStorage.setItem('pendingScans', JSON.stringify(pendingScans)); }

    function addScanToHistory(code) {
      const entry = document.createElement('div');
      entry.className = 'scan-entry';
      entry.textContent = code;
      const codeInt = parseInt(code, 10);
      if (codeInt >= 1 && codeInt <= 300) entry.style.color = 'var(--primary-color)';
      else if (codeInt >= 301 && codeInt <= 600) entry.style.color = 'var(--secondary-color)';
      else entry.style.color = '#fff';
      historyList.prepend(entry);
      if (historyList.childNodes.length > 100) historyList.removeChild(historyList.lastChild);
    }

    function canScan(code) {
      const now = Date.now();
      if (scannedCodes.has(code)) return false;
      if (code === lastScan && (now - lastScanTime) < 3000) return false;
      lastScan = code;
      lastScanTime = now;
      return true;
    }

    function isValidCode(codeInt) { return !isNaN(codeInt) && codeInt >= 1 && codeInt <= maxDossard; }

    function handleNewScan(code) {
      const codeInt = parseInt(code, 10);
      if (!isValidCode(codeInt) || !canScan(code)) return;

      scannedCodes.add(code);
      saveScannedCodes();
      currentScanDiv.textContent = code;
      addScanToHistory(code);
      beepSound.play();
      navigator.vibrate?.(100);
      setTimeout(() => currentScanDiv.textContent = "---", 2000);

      const scanRef = database.ref(`scan_dossards/${code}`);
      scanRef.transaction(current => current === null ? { dateTime: Date.now() } : undefined)
        .catch(() => {
          pendingScans.push({ code, timestamp: Date.now() });
          savePendingScans();
        });
    }

    function syncPendingScans() {
      if (!pendingScans.length) return;
      const toSync = [...pendingScans];
      pendingScans = [];
      toSync.forEach(({ code, timestamp }) => {
        const scanRef = database.ref(`scan_dossards/${code}`);
        scanRef.transaction(current => current === null ? { dateTime: timestamp } : undefined)
          .catch(() => pendingScans.push({ code, timestamp }))
          .finally(savePendingScans);
      });
    }

    // ------------------- SYNCHRONISATION BIDIRECTIONNELLE -------------------
    function syncFirebaseWithLocal() {
      database.ref('scan_dossards').once('value').then(snapshot => {
        const firebaseCodes = new Set();
        snapshot.forEach(child => firebaseCodes.add(child.key));

        // 1️⃣ Mise à jour locale avec Firebase
        scannedCodes = firebaseCodes;
        saveScannedCodes();
        historyList.innerHTML = '';
        scannedCodes.forEach(code => addScanToHistory(code));

        // 2️⃣ Envoyer les scans locaux manquants à Firebase
        pendingScans = pendingScans.filter(({ code, timestamp }) => {
          if (!firebaseCodes.has(code)) {
            const scanRef = database.ref(`scan_dossards/${code}`);
            scanRef.transaction(current => current === null ? { dateTime: timestamp } : undefined)
              .catch(() => pendingScans.push({ code, timestamp }));
            return false; // supprimé de pending car envoyé
          }
          return true;
        });
        savePendingScans();
      });
    }

    function resetCacheIfFirebaseEmpty() {
      return database.ref('scan_dossards').once('value').then(snapshot => {
        if (!snapshot.exists()) {
          scannedCodes.clear();
          pendingScans = [];
          localStorage.removeItem('scannedCodes');
          localStorage.removeItem('pendingScans');
          historyList.innerHTML = '';
        }
      });
    }

    // ------------------- ÉCOUTEUR TEMPS RÉEL -------------------
    function listenRealtimeScans() {
      database.ref('scan_dossards')
        .limitToLast(1)
        .on('child_added', snapshot => {
          const code = snapshot.key;
          if (!scannedCodes.has(code)) {
            scannedCodes.add(code);
            saveScannedCodes();
            addScanToHistory(code);
          }
        });
    }

    function startCamera() {
      Html5Qrcode.getCameras().then(cameras => {
        if (!cameras.length) return;
        const rear = cameras.find(c => c.label.toLowerCase().includes("back")) || cameras[0];
        if (!qrScanner) qrScanner = new Html5Qrcode("reader");

        qrScanner.start(
          { deviceId: { exact: rear.id } },
          { fps: 30, qrbox: { width: 400, height: 400 }, disableFlip: true, experimentalFeatures: { useBarCodeDetectorIfSupported: true } },
          handleNewScan,
          () => {}
        );
      });
    }

    function startApp() {
      resetCacheIfFirebaseEmpty().then(() => {
        syncFirebaseWithLocal();
        listenRealtimeScans();
        startCamera();
        syncPendingScans();
      });
    }

    // ------------------- SYNCHRO QUAND ONLINE -------------------
    window.addEventListener('online', () => {
      syncPendingScans();
      syncFirebaseWithLocal();
    });

    // ------------------- MAX DOSSARD -------------------
    database.ref('data/participants').once('value').then(snapshot => {
      const val = snapshot.val();
      if (val && !isNaN(parseInt(val, 10))) maxDossard = parseInt(val, 10);
    });

    auth.onAuthStateChanged(user => { if (user) startApp(); });
    auth.signInAnonymously().catch(err => alert("Erreur d'authentification: " + err.message));
  </script>
</body>
</html>
