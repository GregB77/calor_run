<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Résultats 10 KM - Calor Run</title>
<style>
:root {
  --primary-blue: #215E99;
  --bg-white: #fff;
  --bg-light: #f9f9f9;
  --shadow-medium: rgba(0,0,0,0.15);
  --border-radius: 8px;
  --max-width: 1000px;
  --text-dark: #333;
  --border-light: #ddd;
  --header-bg: #e0e0e0;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;line-height:1.5;color:var(--text-dark);min-height:100vh;padding:20px;overflow-x:hidden;}
body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(0.25turn,var(--primary-blue),#E61780);opacity:0.3;z-index:-1;}
.container{max-width:var(--max-width);margin:0 auto;}
.header{text-align:center;margin-bottom:20px;color:var(--primary-blue);font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;font-size:1.8rem;font-weight:bold;padding:40px 20px;border-radius:10px;background:url('calor.png') center/contain no-repeat;}
.search-counter-container{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;max-width:1000px;margin-left:auto;margin-right:auto;}
.search-container{flex:1;max-width:300px;}
#search{width:100%;padding:5px;background:transparent;border:none;border-bottom:1px solid #888;font-size:1rem;color:var(--text-dark);outline:none;transition:border-color 0.3s;}
#search:focus{border-bottom-color:var(--primary-blue);}
#counter{white-space:nowrap;font-weight:bold;color:var(--primary-blue);}
.table-container{width:96vw;max-width:1400px;margin:0 auto 20px;background:var(--bg-white);border-radius:var(--border-radius);overflow:hidden;box-shadow:0 4px 12px var(--shadow-medium);}
table{width:100%;border-collapse:collapse;}
th,td{padding:8px 10px;text-align:left;border-bottom:1px solid var(--border-light);}
th{background:var(--header-bg);font-weight:600;text-transform:uppercase;position:sticky;top:0;z-index:10;}
.text-center{text-align:center;}
tbody tr:nth-child(even){background:var(--bg-light);}
.loading{text-align:center;padding:40px;font-size:1.1rem;color:var(--primary-blue);}
.last-update{text-align:center;margin-top:20px;font-size:0.9rem;color:var(--text-dark);}
.hidden{display:none;}
@media(max-width:768px){.table-container{width:98vw;overflow-x:auto;}table{font-size:0.85rem;}th,td{padding:10px 8px;}}
</style>
</head>
<body>
<div class="container">
  <div class="header">RÉSULTATS 10 KM</div>
  <div class="search-counter-container">
    <div class="search-container">
      <input type="text" id="search" placeholder="Rechercher par nom, prénom..." autocomplete="off">
    </div>
    <div id="counter">Arrivées : 0 / 0</div>
  </div>
</div>

<div class="table-container hidden" id="table-container">
  <table>
    <thead>
      <tr>
        <th class="text-center">Dossard</th>
        <th>Nom</th>
        <th>Prénom</th>
        <th class="text-center">Temps</th>
        <th class="text-center">Scratch</th>
        <th class="text-center">Genre</th>
        <th class="text-center">Pos. Genre</th>
        <th class="text-center">Cat</th>
        <th class="text-center">Pos. Cat</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="9" class="loading">Connexion en temps réel...</td></tr>
    </tbody>
  </table>
</div>

<div class="container">
  <p class="last-update hidden" id="last-update">Dernière mise à jour : <span id="update-time">--:--:--</span></p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const FIREBASE_CONFIG={apiKey:"AIzaSyAIAAz51gEGKQd0EoqA3yUhvnqw3DkQiIo",authDomain:"calor-run.firebaseapp.com",databaseURL:"https://calor-run-default-rtdb.europe-west1.firebasedatabase.app",projectId:"calor-run",storageBucket:"calor-run.firebasestorage.app",messagingSenderId:"329949291334",appId:"1:329949291334:web:c71ef20268c609cf953b47",measurementId:"G-YVQPW6JGPK"};
const app=firebase.initializeApp(FIREBASE_CONFIG),db=firebase.database();
const elements={tbody:document.getElementById('tbody'),tableContainer:document.getElementById('table-container'),search:document.getElementById('search'),counter:document.getElementById('counter'),lastUpdate:document.getElementById('last-update'),updateTime:document.getElementById('update-time')};
let participants={},scans={},departureTimestamp=null;

function formatTime(ms){const s=Math.floor(ms/1000),h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sec=s%60;return`${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;}

function updateTable(){
  if(!departureTimestamp)return;
  const data=Object.keys(scans).map(d=>{
    const p=participants[d]||{},s=scans[d]; 
    if(!['10','10km','10 km'].includes(String(p.course||'').trim()))return null;
    const tempsMs=new Date(s.dateTime).getTime()-departureTimestamp;
    return {...p,tempsMs,tempsStr:tempsMs<0?"--:--:--":formatTime(tempsMs)};
  }).filter(Boolean);

  const totalParticipants = Object.values(participants).filter(p=>['10','10km','10 km'].includes(String(p.course||'').trim())).length;
  const arrivals = data.length;
  elements.counter.textContent=`Arrivées : ${arrivals} / ${totalParticipants}`;

  data.sort((a,b)=>a.tempsMs-b.tempsMs);
  const genreCount={},catCount={};
  data.forEach((p,i)=>{p.scratch=i+1;genreCount[p.genre]=(genreCount[p.genre]||0)+1;p.posGenre=genreCount[p.genre];catCount[p.categorie]=(catCount[p.categorie]||0)+1;p.posCat=catCount[p.categorie];});
  
  const frag=document.createDocumentFragment();
  data.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="text-center">${p.dossard}</td><td>${p.nom}</td><td>${p.prenom}</td><td class="text-center">${p.tempsStr}</td><td class="text-center">${p.scratch}</td><td class="text-center">${p.genre||''}</td><td class="text-center">${p.posGenre}</td><td class="text-center">${p.categorie||''}</td><td class="text-center">${p.posCat}</td>`;
    frag.appendChild(tr);
  });
  elements.tbody.innerHTML='';elements.tbody.appendChild(frag);
  elements.tableContainer.classList.remove('hidden');elements.lastUpdate.classList.remove('hidden');elements.updateTime.textContent=new Date().toLocaleTimeString('fr-FR');
}

// Recherche simple
elements.search.addEventListener('input',e=>{
  const term=e.target.value.toLowerCase();
  Object.keys(scans).forEach(d=>{
    const row=elements.tbody.querySelector(`tr:nth-child(${Object.keys(scans).indexOf(d)+1})`);
    if(row)row.style.display=row.textContent.toLowerCase().includes(term)?'':'none';
  });
});

firebase.database().ref('data/depart_course').on('value',snap=>{departureTimestamp=snap.exists()?new Date(snap.val()).getTime():null;updateTable();});
firebase.database().ref('participants').on('value',snap=>{participants=snap.val()||{};updateTable();});
firebase.database().ref('scan_dossards').on('value',snap=>{scans=snap.val()||{};updateTable();});
</script>
</body>
</html>
