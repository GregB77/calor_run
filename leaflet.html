<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>GPX + Profil interactif</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- GPX plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<!-- Elevation plugin -->
<link rel="stylesheet" href="https://unpkg.com/@raruto/leaflet-elevation/dist/leaflet-elevation.min.css" />
<script src="https://unpkg.com/@raruto/leaflet-elevation/dist/leaflet-elevation.min.js"></script>

<style>
    body { margin:0; font-family:Arial; }
    #map { height: 50vh; }
    #profile { height: 40vh; }
    @media (max-width: 700px){
        #map { height: 40vh; }
        #profile { height: 35vh; }
    }
</style>
</head>

<body>

<div id="map"></div>
<div id="profile"></div>

<script>
// --- Initialisation Leaflet ---
const map = L.map("map");

// --- Profil (Elevation plugin) ---
const elevation = L.control.elevation({
    container: "#profile",
    elevationDiv: "#profile",
    followMarker: true,
    theme: "steelblue-theme",
    slope: true,                 // coloration selon la pente
    summary: true,               // stats auto
    useHeightIndicator: true,
    autofitBounds: true,
    time: false,
    legend: false,
    distanceMarkers: true
}).addTo(map);

// --- Charger GPX ---
const gpx = "TRAIL 10KM.gpx"; // ton fichier GPX (http://localhost/...)

// --- Point synchronisé sur la carte ---
let hoverMarker = null;

// --- Ajouter la trace sur la carte ---
new L.GPX(gpx, {
    async: true,
    marker_options: {
        startIconUrl: null,
        endIconUrl: null,
        shadowUrl: null
    }
})
.on("loaded", function(e) {
    map.fitBounds(e.target.getBounds());
})
.on("addline", function(e) {
    // Ajouter la trace au panneau elevation
    elevation.addData(e.line);

    // Événement : survol de la carte → curseur sur profil
    e.line.on("mousemove", function(ev) {
        elevation.showPosition(ev.latlng);
    });
})
.addTo(map);


// --- Synchronisation PROFIL → CARTE ---
elevation.on("elemousemove", function(ev){
    const latlng = ev.latlng;
    if (!latlng) return;

    if (!hoverMarker) {
        hoverMarker = L.circleMarker(latlng, {
            radius: 6,
            weight: 2,
            color: "red",
            fillColor: "white",
            fillOpacity: 0.9
        }).addTo(map);
    } else {
        hoverMarker.setLatLng(latlng);
    }
});

// --- Personnalisation de l’axe X (km entiers) ---
elevation.options.xTicks = 10; // 1 tick / km environ
const originalXTickFormat = elevation._xTickFormat;
elevation._xTickFormat = function(d){
    return Math.floor(d / 1000); // km entiers sans décimales
};

// --- Tooltip distance personnalisée (2 décimales + " km") ---
elevation._distanceFormat = function(d) {
    return (d/1000).toFixed(2) + " km";
};

</script>
</body>
</html>

