<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>GPX + Profil interactif</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- GPX plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>

<!-- Elevation plugin -->
<link rel="stylesheet" href="https://unpkg.com/@raruto/leaflet-elevation/dist/leaflet-elevation.min.css" />
<script src="https://unpkg.com/@raruto/leaflet-elevation/dist/leaflet-elevation.min.js"></script>

<style>
    body { margin:0; font-family:Arial; }
    #map { height: 50vh; }
    #profile { height: 40vh; }
    @media (max-width: 700px){
        #map { height: 40vh; }
        #profile { height: 35vh; }
    }
</style>
</head>

<body>
<div id="map"></div>
<div id="profile"></div>

<script>
// --- Initialisation Leaflet ---
const map = L.map("map");

// --- Ajouter fond de carte ---
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
}).addTo(map);

// --- Profil (Elevation plugin) avec coloration par pente ---
const elevation = L.control.elevation({
    container: "#profile",
    elevationDiv: "#profile",
    followMarker: true,
    theme: "steelblue-theme",
    slope: true,               // <-- coloration par pente activée
    summary: true,
    useHeightIndicator: true,
    autofitBounds: true,
    time: false,
    legend: false,
    distanceMarkers: true
}).addTo(map);

// --- Couleurs personnalisées selon pente (optionnel) ---
elevation.options.slopeColors = [
    { min: -100, max: 0, color: "#0000ff" }, // descente en bleu
    { min: 0, max: 5, color: "#00ff00" },    // pente douce en vert
    { min: 5, max: 100, color: "#ff0000" }   // montée forte en rouge
];

// --- Charger GPX ---
const gpx = "TRAIL 10KM.gpx"; // fichier GPX

let hoverMarker = null;

// --- Ajouter la trace sur la carte ---
new L.GPX(gpx, {
    async: true,
    marker_options: {
        startIconUrl: null,
        endIconUrl: null,
        shadowUrl: null
    }
})
.on("loaded", function(e) {
    map.fitBounds(e.target.getBounds());
})
.on("addline", function(e) {
    elevation.addData(e.line);
})
.addTo(map);

// --- Synchronisation PROFIL → CARTE ---
elevation.on("elemousemove", function(ev){
    const latlng = ev.latlng;
    if (!latlng) return;

    if (!hoverMarker) {
        hoverMarker = L.circleMarker(latlng, {
            radius: 6,
            weight: 2,
            color: "red",
            fillColor: "white",
            fillOpacity: 0.9
        }).addTo(map);
    } else {
        hoverMarker.setLatLng(latlng);
    }
});

// --- Personnalisation de l’axe X (km entiers) ---
elevation.options.xTicks = 10; // 1 tick / km environ
const originalXTickFormat = elevation._xTickFormat;
elevation._xTickFormat = function(d){
    return Math.floor(d / 1000); // km entiers
};

// --- Tooltip distance personnalisée (2 décimales + " km") ---
elevation._distanceFormat = function(d) {
    return (d/1000).toFixed(2) + " km";
};
</script>
</body>
</html>
