<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trail 10KM - Leaflet Heightgraph</title>

    <!-- 1. Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- 2. Leaflet Heightgraph CSS & JS (Inclus D3 via le bundle si dispo, sinon d3 séparé) -->
    <!-- On charge d'abord D3 v5 (nécessaire pour Heightgraph) -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    
    <!-- CSS Heightgraph -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.heightgraph/dist/L.Control.Heightgraph.min.css"/>
    <!-- JS Heightgraph -->
    <script src="https://unpkg.com/leaflet.heightgraph/dist/L.Control.Heightgraph.min.js"></script>

    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; }
        
        /* Header Stats */
        #header-stats {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            flex: 0 0 auto; /* Ne grandit pas */
        }
        .stat-box { text-align: center; margin: 5px 10px; }
        .stat-value { font-size: 1.4em; font-weight: bold; color: #2c3e50; }
        .stat-label { font-size: 0.9em; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Container Carte + Graphique */
        #content-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        #map { 
            flex: 2; /* Prend 2/3 de l'espace restant */
            width: 100%; 
            min-height: 300px;
        }

        /* Le conteneur spécifique où Heightgraph va s'injecter si on ne veut pas qu'il flotte sur la carte */
        #heightgraph-container {
            flex: 1; /* Prend 1/3 de l'espace restant */
            width: 100%;
            background: #fff;
            min-height: 250px;
            position: relative;
        }

        /* Personnalisation de Heightgraph pour qu'il remplisse notre div */
        .heightgraph {
            width: 100%;
            height: 100%;
            background: #fff;
        }
    </style>
</head>
<body>

    <!-- Barre de statistiques calculées manuellement (Heightgraph le fait aussi, mais c'est bien de l'avoir en clair) -->
    <div id="header-stats">
        <div class="stat-box">
            <div class="stat-value" id="distDisplay">--</div>
            <div class="stat-label">Distance</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="eleMaxDisplay">--</div>
            <div class="stat-label">Alt. Max</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="gainDisplay">--</div>
            <div class="stat-label">D+</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="lossDisplay">--</div>
            <div class="stat-label">D-</div>
        </div>
    </div>

    <div id="content-wrapper">
        <div id="map"></div>
        <!-- On prépare une div distincte pour le graphe pour éviter qu'il ne cache la carte -->
        <div id="heightgraph-container"></div>
    </div>

<script>
    // --- 1. CONFIGURATION ---
    const geojsonFile = "TRAIL 10KM.geojson";
    
    const map = L.map('map').setView([0, 0], 10); // Centrage temporaire

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- 2. FONCTION UTILITAIRE : Calcul Stats (D+, D-, Distance) ---
    // Heightgraph fait de l'affichage, mais on calcule les stats globales nous-mêmes pour le header
    function calculateStats(coordinates) {
        let totalDist = 0;
        let totalGain = 0;
        let totalLoss = 0;
        let maxEle = -Infinity;
        let minEle = Infinity;

        for(let i = 0; i < coordinates.length; i++) {
            const [lon, lat, ele] = coordinates[i];
            
            if(ele > maxEle) maxEle = ele;
            if(ele < minEle) minEle = ele;

            if (i > 0) {
                const prev = coordinates[i-1];
                // Formule de Haversine simplifiée ou via Leaflet
                const p1 = L.latLng(prev[1], prev[0]);
                const p2 = L.latLng(lat, lon);
                const d = p1.distanceTo(p2);
                
                totalDist += d;

                const diff = ele - prev[2];
                if (diff > 0) totalGain += diff;
                else totalLoss += Math.abs(diff);
            }
        }

        return {
            distKm: (totalDist / 1000).toFixed(2),
            gain: Math.round(totalGain),
            loss: Math.round(totalLoss),
            max: Math.round(maxEle)
        };
    }

    // --- 3. CHARGEMENT & CONFIG HEIGHTGRAPH ---
    async function loadTrail() {
        try {
            const response = await fetch(geojsonFile);
            if(!response.ok) throw new Error("Fichier introuvable");
            const data = await response.json();

            // Extraction des coordonnées pour nos stats manuelles
            // (Suppose une FeatureLineString simple ou le premier élément d'une collection)
            let coords = [];
            if (data.type === 'FeatureCollection') coords = data.features[0].geometry.coordinates;
            else if (data.type === 'Feature') coords = data.geometry.coordinates;
            else if (data.type === 'LineString') coords = data.coordinates;

            // Mise à jour du header HTML
            const stats = calculateStats(coords);
            document.getElementById('distDisplay').innerText = stats.distKm + " km";
            document.getElementById('gainDisplay').innerText = stats.gain + " m";
            document.getElementById('lossDisplay').innerText = stats.loss + " m";
            document.getElementById('eleMaxDisplay').innerText = stats.max + " m";

            // Ajout de la trace "visuelle" sur la carte (Ligne bleue classique)
            const geoJsonLayer = L.geoJson(data, {
                style: { color: "#007bff", weight: 4, opacity: 0.6 }
            }).addTo(map);
            
            map.fitBounds(geoJsonLayer.getBounds());

            // --- INIT HEIGHTGRAPH ---
            // Le plugin s'attend à recevoir une FeatureCollection GeoJSON.
            // Il va parser la propriété 'elevation' (la coord Z).
            
            const hg = L.control.heightgraph({
                width: document.getElementById('heightgraph-container').offsetWidth, // Largeur dynamique
                height: 250,
                margins: {
                    top: 20,
                    right: 30,
                    bottom: 30,
                    left: 50
                },
                position: "bottomright", // On va feinter et l'injecter dans notre div
                expand: true, // Toujours ouvert
                translation: {
                    distance: "Distance",
                    elevation: "Altitude",
                    segment_length: "Longueur segment",
                    type: "Type",
                    legend: "Légende"
                },
                // xTicks: 10, // Nombre de ticks sur l'axe X
                expandCallback: function() {
                   // Callback si besoin lors de l'ouverture
                }
            });

            // Ajout du contrôle à la carte
            hg.addTo(map);

            // ASTUCE : Pour placer le graphique dans notre div #heightgraph-container 
            // au lieu de flotter sur la carte, on déplace l'élément DOM créé par Leaflet.
            const hgContainer = document.querySelector('.leaflet-control-heightgraph');
            if(hgContainer) {
                // On empêche la propagation des clics pour ne pas bouger la carte quand on clique sur le graphe
                L.DomEvent.disableClickPropagation(hgContainer);
                document.getElementById('heightgraph-container').appendChild(hgContainer);
            }

            // Chargement des données dans le graph
            // Note: Heightgraph est parfois capricieux si les données ne sont pas "enrichies".
            // Par défaut, il affichera l'altitude (Area chart).
            // Pour colorer par pente (gradient), il faudrait pré-analyser le GeoJSON.
            // Ici, nous utilisons le mode simple "elevation" qui utilise la coordonnée Z.
            
            hg.addData(data);
            
            // Gestion du redimensionnement fenêtre
            window.addEventListener('resize', () => {
                hg.resize({
                    width: document.getElementById('heightgraph-container').offsetWidth,
                    height: 250
                });
            });

        } catch (e) {
            console.error("Erreur", e);
            alert("Impossible de charger le fichier GeoJSON. Vérifiez qu'il est bien présent.");
        }
    }

    loadTrail();

</script>
</body>
</html>
